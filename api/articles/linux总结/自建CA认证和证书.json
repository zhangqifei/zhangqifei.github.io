{"title":"自建CA认证和证书","slug":"linux总结/自建CA认证和证书","date":"2016-09-05T16:07:24.000Z","updated":"2019-05-22T03:43:55.175Z","comments":true,"path":"api/articles/linux总结/自建CA认证和证书.json","excerpt":null,"covers":["http://zhangqifei.top/picture/ifeier/data/openssl.jpg","http://zhangqifei.top/picture/ifeier/data/ca.jpg"],"content":"<center><img src=\"http://zhangqifei.top/picture/ifeier/data/openssl.jpg\" width=\"500\" height=\"200\" alt=\"openssl\" align=\"center\"></center>\n\n<p>一些概念：</p>\n<p>PKI：Public Key Infrastructure</p>\n<ul>\n<li>签证机构：CA（Certificate Authority）</li>\n<li>注册机构：RA（Register Authority）</li>\n<li>证书吊销列表：CRL（Certificate Revoke Lists）</li>\n<li>证书存取库</li>\n</ul>\n<p>X.509：定义了证书的结构和认证协议的标准。包括版本号、序列号、签名算法、颁发者、有效期限、主体名称、主体公钥、CRL分发点、扩展信息、发行者签名等</p>\n<p>获取证书的两种方法：</p>\n<ul>\n<li>使用证书授权机构</li>\n<li>生成签名请求（csr）</li>\n<li>将csr发送给CA</li>\n<li>从CA处接收签名</li>\n<li>自签名的证书</li>\n<li>自已签发自己的公钥重点介绍一下自建CA颁发机构和自签名。</li>\n</ul>\n<h2 id=\"自建CA颁发机构和自签名\"><a href=\"#自建CA颁发机构和自签名\" class=\"headerlink\" title=\"自建CA颁发机构和自签名\"></a>自建CA颁发机构和自签名</h2><p>实验用两台服务器，一台做ca颁发证书，一台去请求签名证书。</p>\n<p>证书申请及签署步骤：</p>\n<ol>\n<li>生成申请请求</li>\n<li>CA核验</li>\n<li>CA签署</li>\n<li>获取证书</li>\n</ol>\n<p>我们先看一下openssl的配置文件：<code>/etc/pki/tls/openssl.cnf</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">####################################################################</span></span><br><span class=\"line\">[ ca ]</span><br><span class=\"line\">default_ca\t= CA_default\t\t<span class=\"comment\"># The default ca section(默认的CA配置，是CA_default,下面第一个小节就是)</span></span><br><span class=\"line\"><span class=\"comment\">####################################################################</span></span><br><span class=\"line\">[ CA_default ]</span><br><span class=\"line\">dir\t\t= /etc/pki/CA\t\t<span class=\"comment\"># Where everything is kept （dir变量）</span></span><br><span class=\"line\">certs\t\t= <span class=\"variable\">$dir</span>/certs\t\t<span class=\"comment\"># Where the issued certs are kept（认证证书目录）</span></span><br><span class=\"line\">crl_dir\t\t= <span class=\"variable\">$dir</span>/crl\t\t<span class=\"comment\"># Where the issued crl are kept（注销证书目录）</span></span><br><span class=\"line\">database\t= <span class=\"variable\">$dir</span>/index.txt\t<span class=\"comment\"># database index file.（数据库索引文件）</span></span><br><span class=\"line\">new_certs_dir\t= <span class=\"variable\">$dir</span>/newcerts\t\t<span class=\"comment\"># default place for new certs.（新证书的默认位置）</span></span><br><span class=\"line\">certificate\t= <span class=\"variable\">$dir</span>/cacert.pem \t<span class=\"comment\"># The CA certificate（CA机构证书）</span></span><br><span class=\"line\">serial\t\t= <span class=\"variable\">$dir</span>/serial \t\t<span class=\"comment\"># The current serial number（当前序号，默认为空，可以指定从01开始）</span></span><br><span class=\"line\">crlnumber\t= <span class=\"variable\">$dir</span>/crlnumber\t<span class=\"comment\"># the current crl number（下一个吊销证书序号）</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\"># must be commented out to leave a V1 CRL</span></span><br><span class=\"line\">crl\t\t= <span class=\"variable\">$dir</span>/crl.pem \t\t<span class=\"comment\"># The current CRL（下一个吊销证书）</span></span><br><span class=\"line\">private_key\t= <span class=\"variable\">$dir</span>/private/cakey.pem<span class=\"comment\"># The private key（CA机构的私钥）</span></span><br><span class=\"line\">RANDFILE\t= <span class=\"variable\">$dir</span>/private/.rand\t<span class=\"comment\"># private random number file（随机数文件）</span></span><br><span class=\"line\">x509_extensions\t= usr_cert\t\t<span class=\"comment\"># The extentions to add to the cert</span></span><br><span class=\"line\"><span class=\"comment\"># Comment out the following two lines for the \"traditional\"</span></span><br><span class=\"line\"><span class=\"comment\"># (and highly broken) format.</span></span><br><span class=\"line\">name_opt \t= ca_default\t\t<span class=\"comment\"># Subject Name options（被颁发者，订阅者选项）</span></span><br><span class=\"line\">cert_opt \t= ca_default\t\t<span class=\"comment\"># Certificate field options（认证字段参数）</span></span><br><span class=\"line\"><span class=\"comment\"># Extension copying option: use with caution.</span></span><br><span class=\"line\"><span class=\"comment\"># copy_extensions = copy</span></span><br><span class=\"line\"><span class=\"comment\"># Extensions to add to a CRL. Note: Netscape communicator chokes on V2 CRLs</span></span><br><span class=\"line\"><span class=\"comment\"># so this is commented out by default to leave a V1 CRL.</span></span><br><span class=\"line\"><span class=\"comment\"># crlnumber must also be commented out to leave a V1 CRL.</span></span><br><span class=\"line\"><span class=\"comment\"># crl_extensions\t= crl_ext</span></span><br><span class=\"line\">default_days\t= 365\t\t\t<span class=\"comment\"># how long to certify for （默认的有效期天数是365）</span></span><br><span class=\"line\">default_crl_days= 30\t\t\t<span class=\"comment\"># how long before next CRL</span></span><br><span class=\"line\">default_md\t= sha256\t\t<span class=\"comment\"># use SHA-256 by default</span></span><br><span class=\"line\">preserve\t= no\t\t\t<span class=\"comment\"># keep passed DN ordering</span></span><br><span class=\"line\"><span class=\"comment\"># A few difference way of specifying how similar the request should look</span></span><br><span class=\"line\"><span class=\"comment\"># For type CA, the listed attributes must be the same, and the optional</span></span><br><span class=\"line\"><span class=\"comment\"># and supplied fields are just that :-)</span></span><br><span class=\"line\">policy\t\t= policy_match  <span class=\"comment\"># 是否匹配规则</span></span><br><span class=\"line\"><span class=\"comment\"># For the CA policy</span></span><br><span class=\"line\">[ policy_match ]</span><br><span class=\"line\">countryName\t\t= match   <span class=\"comment\"># 国家名是否匹配，match为匹配</span></span><br><span class=\"line\">stateOrProvinceName\t= match  <span class=\"comment\"># 州或省名是否需要匹配</span></span><br><span class=\"line\">organizationName\t= match  <span class=\"comment\"># 组织名是否需要匹配</span></span><br><span class=\"line\">organizationalUnitName\t= optional <span class=\"comment\"># 组织的部门名字是否需要匹配</span></span><br><span class=\"line\">commonName\t\t= supplied <span class=\"comment\"># 注释</span></span><br><span class=\"line\">emailAddress\t\t= optional <span class=\"comment\"># 邮箱地址</span></span><br><span class=\"line\"><span class=\"comment\"># For the 'anything' policy</span></span><br><span class=\"line\"><span class=\"comment\"># At this point in time, you must list all acceptable 'object'</span></span><br><span class=\"line\"><span class=\"comment\"># types.</span></span><br><span class=\"line\">[ policy_anything ]</span><br><span class=\"line\">countryName\t\t= optional</span><br><span class=\"line\">stateOrProvinceName\t= optional</span><br><span class=\"line\">localityName\t\t= optional</span><br><span class=\"line\">organizationName\t= optional</span><br><span class=\"line\">organizationalUnitName\t= optional</span><br><span class=\"line\">commonName\t\t= supplied</span><br><span class=\"line\">emailAddress\t\t= optional</span><br><span class=\"line\"><span class=\"comment\">####################################################################</span></span><br></pre></td></tr></table></figure></p>\n<p>重点关注下面的几个参数：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir             = /etc/pki/CA           <span class=\"comment\"># Where everything is kept （dir变量）</span></span><br><span class=\"line\">certs           = <span class=\"variable\">$dir</span>/certs            <span class=\"comment\"># Where the issued certs are kept（认证证书目录）</span></span><br><span class=\"line\">database        = <span class=\"variable\">$dir</span>/index.txt        <span class=\"comment\"># database index file.（数据库索引文件）</span></span><br><span class=\"line\">new_certs_dir   = <span class=\"variable\">$dir</span>/newcerts         <span class=\"comment\"># default place for new certs.（新证书的默认位置）</span></span><br><span class=\"line\">certificate     = <span class=\"variable\">$dir</span>/cacert.pem       <span class=\"comment\"># The CA certificate（CA机构证书）</span></span><br><span class=\"line\">serial          = <span class=\"variable\">$dir</span>/serial           <span class=\"comment\"># The current serial number（当前序号，默认为空，可以指定从01开始）</span></span><br><span class=\"line\">private_key     = <span class=\"variable\">$dir</span>/private/cakey.pem<span class=\"comment\"># The private key（CA机构的私钥）</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"1、创建所需要的文件\"><a href=\"#1、创建所需要的文件\" class=\"headerlink\" title=\"1、创建所需要的文件\"></a>1、创建所需要的文件</h3><p><code>touch /etc/pki/CA/index.txt</code>生成证书索引数据库文件</p>\n<p><code>echo 01 &gt; /etc/pki/CA/serial</code>指定第一个颁发证书的序列号,16进制数，比如可以从1a开始，一般从01开始。</p>\n<h3 id=\"2、CA自签证书\"><a href=\"#2、CA自签证书\" class=\"headerlink\" title=\"2、CA自签证书\"></a>2、CA自签证书</h3><p>在作为CA的服务器上操作：</p>\n<ul>\n<li>生成私钥</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@aliyun ~]<span class=\"comment\">#(umask 066;openssl genrsa -out /etc/pki/CA/private/cakey.pem 4096)</span></span><br><span class=\"line\">Generating RSA private key, 4096 bit long modulus</span><br><span class=\"line\">.....++</span><br><span class=\"line\">..............................................++</span><br></pre></td></tr></table></figure>\n<ul>\n<li>生成自签名证书</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@aliyun ~]<span class=\"comment\">#openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days 7300 -out /etc/pki/CA/cacert.pem</span></span><br><span class=\"line\">You are about to be asked to enter information that will be incorporated</span><br><span class=\"line\">into your certificate request.</span><br><span class=\"line\">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class=\"line\">There are quite a few fields but you can leave some blank</span><br><span class=\"line\">For some fields there will be a default value,</span><br><span class=\"line\">If you enter <span class=\"string\">'.'</span>, the field will be left blank.</span><br><span class=\"line\">-----</span><br><span class=\"line\">Country Name (2 letter code) [XX]:CN (国名（2个字母代码）[XX]：CN）</span><br><span class=\"line\">State or Province Name (full name) []:Beijing （州或省名称（全称）北京）</span><br><span class=\"line\">Locality Name (eg, city) [Default City]:Beijing （地区名称（如城市）[默认城市]：北京）</span><br><span class=\"line\">Organization Name (eg, company) [Default Company Ltd]:shangdigongsi （组织名称（如公司）：上帝公司）</span><br><span class=\"line\">Organizational Unit Name (eg, section) []:opt （组织单位名称：opt）</span><br><span class=\"line\">Common Name (eg, your name or your server<span class=\"string\">'s hostname) []:centos （通用名称（例如，您的名字或您的服务器的主机名）[]：centos）</span></span><br><span class=\"line\"><span class=\"string\">Email Address []:1353250703@qq.com （电子邮件地址[]：1353250703@qq.com）</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>参数解析：</p>\n<p>-new: 生成新证书签署请求<br>-x509: 专用于CA生成自签证书<br>-key: 生成请求时用到的私钥文件<br>-days n：证书的有效期限<br>-out /PATH/TO/SOMECERTFILE: 证书的保存路径</p>\n</blockquote>\n<h3 id=\"3、颁发证书\"><a href=\"#3、颁发证书\" class=\"headerlink\" title=\"3、颁发证书\"></a>3、颁发证书</h3><ul>\n<li>在需要使用证书的主机生成证书请求(比如给一台作为博客web服务的服务器生成私钥)</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@aliyun ~]<span class=\"comment\">#(umask 066; openssl genrsa -out /etc/pki/tls/private/blog.key 4096)</span></span><br><span class=\"line\">Generating RSA private key, 4096 bit long modulus</span><br><span class=\"line\">.....................................++</span><br><span class=\"line\">......................................................................................................................++</span><br><span class=\"line\">e is 65537 (0x10001)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>生成证书申请文件</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@aliyun ~]<span class=\"comment\">#openssl req -new -key /etc/pki/tls/private/blog.key -days 3560 -out /etc/pki/tls/blog.csr</span></span><br><span class=\"line\">You are about to be asked to enter information that will be incorporated</span><br><span class=\"line\">into your certificate request.</span><br><span class=\"line\">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class=\"line\">There are quite a few fields but you can leave some blank</span><br><span class=\"line\">For some fields there will be a default value,</span><br><span class=\"line\">If you enter <span class=\"string\">'.'</span>, the field will be left blank.</span><br><span class=\"line\">-----</span><br><span class=\"line\">Country Name (2 letter code) [XX]:CN (国名（2个字母代码）[XX]：CN）</span><br><span class=\"line\">State or Province Name (full name) []:Beijing（州或省名称（全称）北京）</span><br><span class=\"line\">Locality Name (eg, city) [Default City]:Bejing （地区名称（如城市）[默认城市]：北京）</span><br><span class=\"line\">Organization Name (eg, company) [Default Company Ltd]:shangdigongsi（组织名称（如公司）：上帝公司）</span><br><span class=\"line\">Organizational Unit Name (eg, section) []:centos（组织单位名称：opt）</span><br><span class=\"line\">Common Name (eg, your name or your server<span class=\"string\">'s hostname) []:opt （通用名称（例如，您的名字或您的服务器的主机名）[]：centos）</span></span><br><span class=\"line\"><span class=\"string\">Email Address []:（电子邮件地址[]：1353250703@qq.com）</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Please enter the following '</span>extra<span class=\"string\">' attributes （请输入以下“额外”属性）</span></span><br><span class=\"line\"><span class=\"string\">to be sent with your certificate request（要发送您的证书请求）</span></span><br><span class=\"line\"><span class=\"string\">A challenge password []:（密码[ ]：）</span></span><br><span class=\"line\"><span class=\"string\">An optional company name []:（可选的公司名称）</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>将证书请求文件传输给CA</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@aliyun ~]<span class=\"comment\">#scp /etc/pki/tls/blog.csr root@172.16.111.100:/tmp/</span></span><br><span class=\"line\">root@172.16.111.100s password</span><br><span class=\"line\">blog.csr                       100% 1773    1.7Mb/s</span><br></pre></td></tr></table></figure>\n<ul>\n<li>CA签署证书，并将证书颁发给请求者</li>\n</ul>\n<center><img src=\"http://zhangqifei.top/picture/ifeier/data/ca.jpg\" width=\"500\" height=\"200\" alt=\"openssl\" align=\"center\"></center>\n\n<blockquote>\n<p>注意：默认国家，省，公司名称三项必须和CA一致</p>\n</blockquote>\n<ul>\n<li>把blog.crt证书回传给申请者，申请者可以使用此证书。</li>\n</ul>\n<blockquote>\n<p>证书可以放在网站里，比如tomacat服务有专门存放证书的地方，还有可能需要转化格式，此处使用方法暂略</p>\n</blockquote>\n<h3 id=\"4、吊销证书\"><a href=\"#4、吊销证书\" class=\"headerlink\" title=\"4、吊销证书\"></a>4、吊销证书</h3><ul>\n<li>在客户端获取要吊销的证书的serial</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl x509 -<span class=\"keyword\">in</span> /PATH/FROM/CERT_FILE -noout -serial -subject</span><br></pre></td></tr></table></figure>\n<ul>\n<li>在CA上，根据客户提交的serial与subject信息，对比检验是否与index.txt文件中的信息一致，吊销证书：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl ca -revoke /etc/pki/CA/newcerts/SERIAL.pem</span><br></pre></td></tr></table></figure>\n<ul>\n<li>指定第一个吊销证书的编号<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> 01 &gt; /etc/pki/CA/crlnumber</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p>注意：这里只有在第一次更新证书吊销列表前，才需要执行指定编号。</p>\n</blockquote>\n<ul>\n<li>更新证书吊销列表</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl ca -gencrl -out /etc/pki/CA/crl/crl.pem</span><br></pre></td></tr></table></figure>\n<ul>\n<li>查看crl文件：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl crl -<span class=\"keyword\">in</span> /etc/pki/CA/crl/crl.pem -noout -text</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><a href=\"https://www.zybuluo.com/mrz1/note/1011025\" target=\"_blank\" rel=\"noopener\">更加详细的步骤以及代码实现hexo</a></p>\n</blockquote>\n","more":"<center><img src=\"http://zhangqifei.top/picture/ifeier/data/openssl.jpg\" width=\"500\" height=\"200\" alt=\"openssl\" align=\"center\"></center>\n\n<p>一些概念：</p>\n<p>PKI：Public Key Infrastructure</p>\n<ul>\n<li>签证机构：CA（Certificate Authority）</li>\n<li>注册机构：RA（Register Authority）</li>\n<li>证书吊销列表：CRL（Certificate Revoke Lists）</li>\n<li>证书存取库</li>\n</ul>\n<p>X.509：定义了证书的结构和认证协议的标准。包括版本号、序列号、签名算法、颁发者、有效期限、主体名称、主体公钥、CRL分发点、扩展信息、发行者签名等</p>\n<p>获取证书的两种方法：</p>\n<ul>\n<li>使用证书授权机构</li>\n<li>生成签名请求（csr）</li>\n<li>将csr发送给CA</li>\n<li>从CA处接收签名</li>\n<li>自签名的证书</li>\n<li>自已签发自己的公钥重点介绍一下自建CA颁发机构和自签名。</li>\n</ul>\n<h2 id=\"自建CA颁发机构和自签名\"><a href=\"#自建CA颁发机构和自签名\" class=\"headerlink\" title=\"自建CA颁发机构和自签名\"></a>自建CA颁发机构和自签名</h2><p>实验用两台服务器，一台做ca颁发证书，一台去请求签名证书。</p>\n<p>证书申请及签署步骤：</p>\n<ol>\n<li>生成申请请求</li>\n<li>CA核验</li>\n<li>CA签署</li>\n<li>获取证书</li>\n</ol>\n<p>我们先看一下openssl的配置文件：<code>/etc/pki/tls/openssl.cnf</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">####################################################################</span></span><br><span class=\"line\">[ ca ]</span><br><span class=\"line\">default_ca\t= CA_default\t\t<span class=\"comment\"># The default ca section(默认的CA配置，是CA_default,下面第一个小节就是)</span></span><br><span class=\"line\"><span class=\"comment\">####################################################################</span></span><br><span class=\"line\">[ CA_default ]</span><br><span class=\"line\">dir\t\t= /etc/pki/CA\t\t<span class=\"comment\"># Where everything is kept （dir变量）</span></span><br><span class=\"line\">certs\t\t= <span class=\"variable\">$dir</span>/certs\t\t<span class=\"comment\"># Where the issued certs are kept（认证证书目录）</span></span><br><span class=\"line\">crl_dir\t\t= <span class=\"variable\">$dir</span>/crl\t\t<span class=\"comment\"># Where the issued crl are kept（注销证书目录）</span></span><br><span class=\"line\">database\t= <span class=\"variable\">$dir</span>/index.txt\t<span class=\"comment\"># database index file.（数据库索引文件）</span></span><br><span class=\"line\">new_certs_dir\t= <span class=\"variable\">$dir</span>/newcerts\t\t<span class=\"comment\"># default place for new certs.（新证书的默认位置）</span></span><br><span class=\"line\">certificate\t= <span class=\"variable\">$dir</span>/cacert.pem \t<span class=\"comment\"># The CA certificate（CA机构证书）</span></span><br><span class=\"line\">serial\t\t= <span class=\"variable\">$dir</span>/serial \t\t<span class=\"comment\"># The current serial number（当前序号，默认为空，可以指定从01开始）</span></span><br><span class=\"line\">crlnumber\t= <span class=\"variable\">$dir</span>/crlnumber\t<span class=\"comment\"># the current crl number（下一个吊销证书序号）</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\"># must be commented out to leave a V1 CRL</span></span><br><span class=\"line\">crl\t\t= <span class=\"variable\">$dir</span>/crl.pem \t\t<span class=\"comment\"># The current CRL（下一个吊销证书）</span></span><br><span class=\"line\">private_key\t= <span class=\"variable\">$dir</span>/private/cakey.pem<span class=\"comment\"># The private key（CA机构的私钥）</span></span><br><span class=\"line\">RANDFILE\t= <span class=\"variable\">$dir</span>/private/.rand\t<span class=\"comment\"># private random number file（随机数文件）</span></span><br><span class=\"line\">x509_extensions\t= usr_cert\t\t<span class=\"comment\"># The extentions to add to the cert</span></span><br><span class=\"line\"><span class=\"comment\"># Comment out the following two lines for the \"traditional\"</span></span><br><span class=\"line\"><span class=\"comment\"># (and highly broken) format.</span></span><br><span class=\"line\">name_opt \t= ca_default\t\t<span class=\"comment\"># Subject Name options（被颁发者，订阅者选项）</span></span><br><span class=\"line\">cert_opt \t= ca_default\t\t<span class=\"comment\"># Certificate field options（认证字段参数）</span></span><br><span class=\"line\"><span class=\"comment\"># Extension copying option: use with caution.</span></span><br><span class=\"line\"><span class=\"comment\"># copy_extensions = copy</span></span><br><span class=\"line\"><span class=\"comment\"># Extensions to add to a CRL. Note: Netscape communicator chokes on V2 CRLs</span></span><br><span class=\"line\"><span class=\"comment\"># so this is commented out by default to leave a V1 CRL.</span></span><br><span class=\"line\"><span class=\"comment\"># crlnumber must also be commented out to leave a V1 CRL.</span></span><br><span class=\"line\"><span class=\"comment\"># crl_extensions\t= crl_ext</span></span><br><span class=\"line\">default_days\t= 365\t\t\t<span class=\"comment\"># how long to certify for （默认的有效期天数是365）</span></span><br><span class=\"line\">default_crl_days= 30\t\t\t<span class=\"comment\"># how long before next CRL</span></span><br><span class=\"line\">default_md\t= sha256\t\t<span class=\"comment\"># use SHA-256 by default</span></span><br><span class=\"line\">preserve\t= no\t\t\t<span class=\"comment\"># keep passed DN ordering</span></span><br><span class=\"line\"><span class=\"comment\"># A few difference way of specifying how similar the request should look</span></span><br><span class=\"line\"><span class=\"comment\"># For type CA, the listed attributes must be the same, and the optional</span></span><br><span class=\"line\"><span class=\"comment\"># and supplied fields are just that :-)</span></span><br><span class=\"line\">policy\t\t= policy_match  <span class=\"comment\"># 是否匹配规则</span></span><br><span class=\"line\"><span class=\"comment\"># For the CA policy</span></span><br><span class=\"line\">[ policy_match ]</span><br><span class=\"line\">countryName\t\t= match   <span class=\"comment\"># 国家名是否匹配，match为匹配</span></span><br><span class=\"line\">stateOrProvinceName\t= match  <span class=\"comment\"># 州或省名是否需要匹配</span></span><br><span class=\"line\">organizationName\t= match  <span class=\"comment\"># 组织名是否需要匹配</span></span><br><span class=\"line\">organizationalUnitName\t= optional <span class=\"comment\"># 组织的部门名字是否需要匹配</span></span><br><span class=\"line\">commonName\t\t= supplied <span class=\"comment\"># 注释</span></span><br><span class=\"line\">emailAddress\t\t= optional <span class=\"comment\"># 邮箱地址</span></span><br><span class=\"line\"><span class=\"comment\"># For the 'anything' policy</span></span><br><span class=\"line\"><span class=\"comment\"># At this point in time, you must list all acceptable 'object'</span></span><br><span class=\"line\"><span class=\"comment\"># types.</span></span><br><span class=\"line\">[ policy_anything ]</span><br><span class=\"line\">countryName\t\t= optional</span><br><span class=\"line\">stateOrProvinceName\t= optional</span><br><span class=\"line\">localityName\t\t= optional</span><br><span class=\"line\">organizationName\t= optional</span><br><span class=\"line\">organizationalUnitName\t= optional</span><br><span class=\"line\">commonName\t\t= supplied</span><br><span class=\"line\">emailAddress\t\t= optional</span><br><span class=\"line\"><span class=\"comment\">####################################################################</span></span><br></pre></td></tr></table></figure></p>\n<p>重点关注下面的几个参数：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir             = /etc/pki/CA           <span class=\"comment\"># Where everything is kept （dir变量）</span></span><br><span class=\"line\">certs           = <span class=\"variable\">$dir</span>/certs            <span class=\"comment\"># Where the issued certs are kept（认证证书目录）</span></span><br><span class=\"line\">database        = <span class=\"variable\">$dir</span>/index.txt        <span class=\"comment\"># database index file.（数据库索引文件）</span></span><br><span class=\"line\">new_certs_dir   = <span class=\"variable\">$dir</span>/newcerts         <span class=\"comment\"># default place for new certs.（新证书的默认位置）</span></span><br><span class=\"line\">certificate     = <span class=\"variable\">$dir</span>/cacert.pem       <span class=\"comment\"># The CA certificate（CA机构证书）</span></span><br><span class=\"line\">serial          = <span class=\"variable\">$dir</span>/serial           <span class=\"comment\"># The current serial number（当前序号，默认为空，可以指定从01开始）</span></span><br><span class=\"line\">private_key     = <span class=\"variable\">$dir</span>/private/cakey.pem<span class=\"comment\"># The private key（CA机构的私钥）</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"1、创建所需要的文件\"><a href=\"#1、创建所需要的文件\" class=\"headerlink\" title=\"1、创建所需要的文件\"></a>1、创建所需要的文件</h3><p><code>touch /etc/pki/CA/index.txt</code>生成证书索引数据库文件</p>\n<p><code>echo 01 &gt; /etc/pki/CA/serial</code>指定第一个颁发证书的序列号,16进制数，比如可以从1a开始，一般从01开始。</p>\n<h3 id=\"2、CA自签证书\"><a href=\"#2、CA自签证书\" class=\"headerlink\" title=\"2、CA自签证书\"></a>2、CA自签证书</h3><p>在作为CA的服务器上操作：</p>\n<ul>\n<li>生成私钥</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@aliyun ~]<span class=\"comment\">#(umask 066;openssl genrsa -out /etc/pki/CA/private/cakey.pem 4096)</span></span><br><span class=\"line\">Generating RSA private key, 4096 bit long modulus</span><br><span class=\"line\">.....++</span><br><span class=\"line\">..............................................++</span><br></pre></td></tr></table></figure>\n<ul>\n<li>生成自签名证书</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@aliyun ~]<span class=\"comment\">#openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days 7300 -out /etc/pki/CA/cacert.pem</span></span><br><span class=\"line\">You are about to be asked to enter information that will be incorporated</span><br><span class=\"line\">into your certificate request.</span><br><span class=\"line\">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class=\"line\">There are quite a few fields but you can leave some blank</span><br><span class=\"line\">For some fields there will be a default value,</span><br><span class=\"line\">If you enter <span class=\"string\">'.'</span>, the field will be left blank.</span><br><span class=\"line\">-----</span><br><span class=\"line\">Country Name (2 letter code) [XX]:CN (国名（2个字母代码）[XX]：CN）</span><br><span class=\"line\">State or Province Name (full name) []:Beijing （州或省名称（全称）北京）</span><br><span class=\"line\">Locality Name (eg, city) [Default City]:Beijing （地区名称（如城市）[默认城市]：北京）</span><br><span class=\"line\">Organization Name (eg, company) [Default Company Ltd]:shangdigongsi （组织名称（如公司）：上帝公司）</span><br><span class=\"line\">Organizational Unit Name (eg, section) []:opt （组织单位名称：opt）</span><br><span class=\"line\">Common Name (eg, your name or your server<span class=\"string\">'s hostname) []:centos （通用名称（例如，您的名字或您的服务器的主机名）[]：centos）</span></span><br><span class=\"line\"><span class=\"string\">Email Address []:1353250703@qq.com （电子邮件地址[]：1353250703@qq.com）</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>参数解析：</p>\n<p>-new: 生成新证书签署请求<br>-x509: 专用于CA生成自签证书<br>-key: 生成请求时用到的私钥文件<br>-days n：证书的有效期限<br>-out /PATH/TO/SOMECERTFILE: 证书的保存路径</p>\n</blockquote>\n<h3 id=\"3、颁发证书\"><a href=\"#3、颁发证书\" class=\"headerlink\" title=\"3、颁发证书\"></a>3、颁发证书</h3><ul>\n<li>在需要使用证书的主机生成证书请求(比如给一台作为博客web服务的服务器生成私钥)</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@aliyun ~]<span class=\"comment\">#(umask 066; openssl genrsa -out /etc/pki/tls/private/blog.key 4096)</span></span><br><span class=\"line\">Generating RSA private key, 4096 bit long modulus</span><br><span class=\"line\">.....................................++</span><br><span class=\"line\">......................................................................................................................++</span><br><span class=\"line\">e is 65537 (0x10001)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>生成证书申请文件</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@aliyun ~]<span class=\"comment\">#openssl req -new -key /etc/pki/tls/private/blog.key -days 3560 -out /etc/pki/tls/blog.csr</span></span><br><span class=\"line\">You are about to be asked to enter information that will be incorporated</span><br><span class=\"line\">into your certificate request.</span><br><span class=\"line\">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class=\"line\">There are quite a few fields but you can leave some blank</span><br><span class=\"line\">For some fields there will be a default value,</span><br><span class=\"line\">If you enter <span class=\"string\">'.'</span>, the field will be left blank.</span><br><span class=\"line\">-----</span><br><span class=\"line\">Country Name (2 letter code) [XX]:CN (国名（2个字母代码）[XX]：CN）</span><br><span class=\"line\">State or Province Name (full name) []:Beijing（州或省名称（全称）北京）</span><br><span class=\"line\">Locality Name (eg, city) [Default City]:Bejing （地区名称（如城市）[默认城市]：北京）</span><br><span class=\"line\">Organization Name (eg, company) [Default Company Ltd]:shangdigongsi（组织名称（如公司）：上帝公司）</span><br><span class=\"line\">Organizational Unit Name (eg, section) []:centos（组织单位名称：opt）</span><br><span class=\"line\">Common Name (eg, your name or your server<span class=\"string\">'s hostname) []:opt （通用名称（例如，您的名字或您的服务器的主机名）[]：centos）</span></span><br><span class=\"line\"><span class=\"string\">Email Address []:（电子邮件地址[]：1353250703@qq.com）</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Please enter the following '</span>extra<span class=\"string\">' attributes （请输入以下“额外”属性）</span></span><br><span class=\"line\"><span class=\"string\">to be sent with your certificate request（要发送您的证书请求）</span></span><br><span class=\"line\"><span class=\"string\">A challenge password []:（密码[ ]：）</span></span><br><span class=\"line\"><span class=\"string\">An optional company name []:（可选的公司名称）</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>将证书请求文件传输给CA</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@aliyun ~]<span class=\"comment\">#scp /etc/pki/tls/blog.csr root@172.16.111.100:/tmp/</span></span><br><span class=\"line\">root@172.16.111.100s password</span><br><span class=\"line\">blog.csr                       100% 1773    1.7Mb/s</span><br></pre></td></tr></table></figure>\n<ul>\n<li>CA签署证书，并将证书颁发给请求者</li>\n</ul>\n<center><img src=\"http://zhangqifei.top/picture/ifeier/data/ca.jpg\" width=\"500\" height=\"200\" alt=\"openssl\" align=\"center\"></center>\n\n<blockquote>\n<p>注意：默认国家，省，公司名称三项必须和CA一致</p>\n</blockquote>\n<ul>\n<li>把blog.crt证书回传给申请者，申请者可以使用此证书。</li>\n</ul>\n<blockquote>\n<p>证书可以放在网站里，比如tomacat服务有专门存放证书的地方，还有可能需要转化格式，此处使用方法暂略</p>\n</blockquote>\n<h3 id=\"4、吊销证书\"><a href=\"#4、吊销证书\" class=\"headerlink\" title=\"4、吊销证书\"></a>4、吊销证书</h3><ul>\n<li>在客户端获取要吊销的证书的serial</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl x509 -<span class=\"keyword\">in</span> /PATH/FROM/CERT_FILE -noout -serial -subject</span><br></pre></td></tr></table></figure>\n<ul>\n<li>在CA上，根据客户提交的serial与subject信息，对比检验是否与index.txt文件中的信息一致，吊销证书：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl ca -revoke /etc/pki/CA/newcerts/SERIAL.pem</span><br></pre></td></tr></table></figure>\n<ul>\n<li>指定第一个吊销证书的编号<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> 01 &gt; /etc/pki/CA/crlnumber</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p>注意：这里只有在第一次更新证书吊销列表前，才需要执行指定编号。</p>\n</blockquote>\n<ul>\n<li>更新证书吊销列表</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl ca -gencrl -out /etc/pki/CA/crl/crl.pem</span><br></pre></td></tr></table></figure>\n<ul>\n<li>查看crl文件：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl crl -<span class=\"keyword\">in</span> /etc/pki/CA/crl/crl.pem -noout -text</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><a href=\"https://www.zybuluo.com/mrz1/note/1011025\" target=\"_blank\" rel=\"noopener\">更加详细的步骤以及代码实现hexo</a></p>\n</blockquote>\n","categories":[{"name":"linux总结","path":"api/categories/linux总结.json"}],"tags":[{"name":"CA","path":"api/tags/CA.json"}]}