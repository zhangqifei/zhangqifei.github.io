{"title":"全局初始化","slug":"shell脚本/全局初始化","date":"2019-06-28T03:50:51.840Z","updated":"2019-07-01T06:25:24.969Z","comments":true,"path":"api/articles/shell脚本/全局初始化.json","excerpt":null,"covers":null,"content":"<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#********************************************************************</span></span><br><span class=\"line\"><span class=\"comment\">#encoding  -*-utf8-*-</span></span><br><span class=\"line\"><span class=\"comment\">#Author:</span></span><br><span class=\"line\"><span class=\"comment\">#Date:         2017-12-19</span></span><br><span class=\"line\"><span class=\"comment\">#URL: </span></span><br><span class=\"line\"><span class=\"comment\">#Description：  The test script</span></span><br><span class=\"line\"><span class=\"comment\">#Copyright (C):    2017 All rights reserved</span></span><br><span class=\"line\"><span class=\"comment\">#QQ Numbers:</span></span><br><span class=\"line\"><span class=\"comment\">#********************************************************************</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看系统版本 </span></span><br><span class=\"line\">Get_host_version=`cat /etc/centos-release | grep -i centos | grep -o <span class=\"string\">\"\\&lt;[[:digit:]]\\+\"</span> |head -1`</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看内核版本</span></span><br><span class=\"line\">kernel_version=`uname -r`</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#设置开机启动文件的权限,设置开机脚本</span></span><br><span class=\"line\">chmod +x /etc/rc.d/rc.local</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装wget必备工具($?上一个执行结果，$$当前进程ID)</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Install_wget</span></span>()&#123;</span><br><span class=\"line\">    mount /dev/sr0 /mnt</span><br><span class=\"line\">    [ $? -ne 0 ] &amp;&amp; &#123; <span class=\"built_in\">echo</span> <span class=\"string\">\"未添加光盘源！退出脚本\"</span> ； <span class=\"built_in\">kill</span> -9 $$ ; &#125;</span><br><span class=\"line\">    rpm -ivh /mnt/Packages/wget*</span><br><span class=\"line\">    <span class=\"built_in\">cd</span> /</span><br><span class=\"line\">    umount /mnt    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改字符集位zh_CN.UTF-8</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Modify_charaset</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">'export LANG=zh_CN.UTF-8'</span> &gt;&gt;/etc/profile</span><br><span class=\"line\">    <span class=\"built_in\">export</span> LANG=zh_CN.UTF-8</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#输出错误的系统版本</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Error_system_version</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"未知的系统版本 <span class=\"variable\">$Get_host_version</span>\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#备份操作的相关目录</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Bakup_etc</span></span>()&#123;</span><br><span class=\"line\">    Now_of_time=`date +<span class=\"string\">'%F_%H.%M'</span>`</span><br><span class=\"line\">    back_path=/bak/initsys/</span><br><span class=\"line\">    mkdir -p <span class=\"variable\">$back_path</span></span><br><span class=\"line\">    tar -czf <span class=\"variable\">$back_path</span>/etc.<span class=\"variable\">$&#123;Now_of_time&#125;</span>.tar.gz /etc</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#关闭防火墙和selinux(getenforce 获取)</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Off_firewall_and_selinux</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"comment\">#off firewall</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == 7 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        systemctl stop firewalld &amp;&gt;/dev/null</span><br><span class=\"line\">        systemctl <span class=\"built_in\">disable</span> firewalld &amp;&gt;/dev/null</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == 6 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        service iptables stop &amp;&gt;/dev/null</span><br><span class=\"line\">        chkconfig iptables off &amp;&gt;/dev/null</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">        <span class=\"built_in\">return</span> 1</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"comment\">#off selinux</span></span><br><span class=\"line\">    sed -ri <span class=\"string\">'s/^(SELINUX=).*$/\\1disabled/g'</span> /etc/selinux/config</span><br><span class=\"line\">    setenforce 0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置时区和时间</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Set_timezone_and_time</span></span>()&#123;</span><br><span class=\"line\">    /usr/bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class=\"line\">    /usr/sbin/ntpdate 10.180.4.204 <span class=\"comment\">#设置ntp服务器同步，如果需要取消注释</span></span><br><span class=\"line\">    hwclock -w <span class=\"comment\">#同步系统时间到硬件时间</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == <span class=\"string\">'6'</span> ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        cat &gt; /etc/sysconfig/clock &lt;&lt; EOF</span><br><span class=\"line\">ZONE=<span class=\"string\">\"Asia/Shanghai\"</span></span><br><span class=\"line\">UTC=<span class=\"literal\">false</span></span><br><span class=\"line\">ARC=<span class=\"literal\">false</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == <span class=\"string\">'7'</span> ] </span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        timedatectl <span class=\"built_in\">set</span>-local-rtc yes</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    <span class=\"keyword\">fi</span>    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#隐藏系统版本</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Shadow_system_version</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">''</span> &gt; /etc/issue</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">''</span> &gt; /etc/motd</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">''</span> &gt; /etc/redhat-release</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">''</span> &gt; /etc/centos-release</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#测试外网是否连通</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Test_network</span></span>()&#123;</span><br><span class=\"line\">    ping -c1 www.baidu.com &amp;&gt;/dev/null</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ $? -eq 0 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">return</span> 0</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">return</span> 1</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#设置系统最大句柄数</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Set_handler_Num</span></span>()&#123;</span><br><span class=\"line\">    limit_count=`cat /etc/security/limits.conf | grep <span class=\"string\">\"^\\*[[:blank:]]\\+\\(soft\\|hard\\)[[:blank:]]\\+\\(nofile\\|nproc\\)[[:blank:]]\\+\"</span> | wc -l`</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$limit_count</span>\"</span> -eq 0 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class=\"line\">*   soft   nofile   102400 </span><br><span class=\"line\">*   hard   nofile   102400</span><br><span class=\"line\">*   soft   nproc    40960</span><br><span class=\"line\">*   hard   nproc    40960</span><br><span class=\"line\">EOF</span><br><span class=\"line\">        <span class=\"built_in\">ulimit</span> -n 102400 <span class=\"comment\">#设置文件打开数,并马上生效，</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"已经添加过limit限制!\"</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#优化tcp连接</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Set_tcp_kernel_arguments</span></span>()&#123;</span><br><span class=\"line\">    kernel_args=/etc/sysctl.d/tcp_optimization.conf</span><br><span class=\"line\">    flag_1=`cat <span class=\"variable\">$kernel_args</span> 2&gt;/dev/null | grep tcp_flag | awk <span class=\"string\">'&#123;print $2&#125;'</span>`</span><br><span class=\"line\">    flag_2=`cat <span class=\"variable\">$kernel_args</span> 2&gt;/dev/null | grep tcp_flag | wc -l`</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$flag_2</span>\"</span> -gt 1 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"系统错误，TCP重复的优化参数，请查看 <span class=\"variable\">$kernel_args</span> 是否正确!\"</span></span><br><span class=\"line\">        <span class=\"built_in\">return</span> 1</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$flag_1</span>\"</span> == 1 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"TCP内核参数已经优化过了。\"</span></span><br><span class=\"line\">        <span class=\"built_in\">return</span> 1</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"#tcp_flag 1\"</span> &gt;&gt;<span class=\"variable\">$kernel_args</span></span><br><span class=\"line\">    touch <span class=\"variable\">$kernel_args</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_syncookies = 1\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_tw_recycle = 1\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#表示开启TCP连接中TIME-WAIT sockets的快速回收</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_tw_reuse = 1\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_fin_timeout = 5\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">##指定孤儿连接在内核中生存的时间为5秒 </span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_keepalive_time = 1200\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#表示当keepalive起用的时候，TCP发送keepalive消息的频度。缺省&gt;是2小时，改为20分钟</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.ip_local_port_range = 10000 65000\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#表示用于向外连接的端口范围</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_max_syn_backlog = 8192\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_max_tw_buckets = 5000\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#表示系统同时保持TIME_WAIT的最大数量，如果超过这个数字，TIME_WAIT将立刻被清除并打印警告信息。</span></span><br><span class=\"line\">    sysctl -p <span class=\"variable\">$kernel_args</span> &amp;&gt;/dev/null</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ $? != 0 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">'读取Tcp内核参数错误！'</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#禁用ssh的DNS功能</span></span><br><span class=\"line\"><span class=\"comment\">#在操作中，我们都会用SSH协议来远程控制虚拟机，但是在输入用户名时候，会有一段时间的卡顿，此时正在进行SSH协议的DNS解析，我们为了快速的连接到虚拟机上，就要关闭这个解析过程</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Disabled_sshd_dns</span></span>()&#123;</span><br><span class=\"line\">    [ `grep <span class=\"string\">\"^#UseDNS \\(no\\|yes\\)\"</span> /etc/ssh/sshd_config | wc -l` -eq 0 ] &amp;&amp; &#123; <span class=\"built_in\">echo</span> <span class=\"string\">'已禁用该配置，Do nothing！'</span> ; <span class=\"built_in\">return</span> 1; &#125;</span><br><span class=\"line\">    sed -ri <span class=\"string\">'s@#UseDNS (no|yes)@UseDNS no@g'</span> /etc/ssh/sshd_config</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == <span class=\"string\">'6'</span> ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        service sshd restart</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == <span class=\"string\">'7'</span> ] </span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        systemctl restart sshd</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置网卡名称为eth*</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Modify_network_card_name</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == <span class=\"string\">'6'</span> ] <span class=\"comment\">#修改Centos6 的网卡</span></span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        Count_cart=`cat /etc/udev/rules.d/70-persistent-net.rules | grep <span class=\"string\">'SUBSYSTEM==\"net\", ACTION==\"add\"'</span> | wc -l`</span><br><span class=\"line\">        [ <span class=\"string\">\"<span class=\"variable\">$Count_cart</span>\"</span> -eq 0 ] &amp;&amp; &#123; <span class=\"built_in\">echo</span> <span class=\"string\">\"没有网卡信息，请检查网卡驱动！\"</span> ; <span class=\"built_in\">return</span> 1; &#125;</span><br><span class=\"line\">        count=1</span><br><span class=\"line\">        All_mac=`cat 70-persistent-net.rules | grep <span class=\"string\">'SUBSYSTEM==\"net\", ACTION==\"add\"'</span> |grep -o <span class=\"string\">\"\\([0-9a-fA-F]\\&#123;2\\&#125;:\\)\\&#123;5\\&#125;[0-9a-fA-F]\\&#123;2\\&#125;\"</span>`</span><br><span class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"variable\">$ALL_mac</span>`</span><br><span class=\"line\">            <span class=\"keyword\">do</span></span><br><span class=\"line\">            sed -ri <span class=\"string\">'s@('</span><span class=\"variable\">$i</span><span class=\"string\">'.*NAME=\").*[[:digit:]]+\"$@\\1eth'</span><span class=\"variable\">$count</span><span class=\"string\">'$\"@'</span> /etc/udev/rules.d/70-persistent-net.rules</span><br><span class=\"line\">            <span class=\"built_in\">let</span> count+=1</span><br><span class=\"line\">            <span class=\"keyword\">done</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">'修改网卡名成功,请查看配置!'</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"`cat /etc/udev/rules.d/70-persistent-net.rules | grep 'SUBSYSTEM==\"</span>net<span class=\"string\">\", ACTION==\"</span>add<span class=\"string\">\", DRIVERS==\"</span>?*<span class=\"string\">\", ATTR&#123;address&#125;==\"</span><span class=\"string\">'`\"</span></span><br><span class=\"line\"><span class=\"string\">    elif [ \"$Get_host_version\" == '</span>7<span class=\"string\">' ] #修改Centos7 的网卡</span></span><br><span class=\"line\"><span class=\"string\">        then</span></span><br><span class=\"line\"><span class=\"string\">        boot_grub=/boot/grub2/grub.cfg</span></span><br><span class=\"line\"><span class=\"string\">        grub_default_cfg=/etc/default/grub</span></span><br><span class=\"line\"><span class=\"string\">        Name_count=`cat  $boot_grub 2&gt;/dev/null | grep \"quiet[[:blank:]]\\+net.ifnames\" | wc -l`</span></span><br><span class=\"line\"><span class=\"string\">        cp $grub_default_cfg $&#123;grub_default_cfg&#125;.`date +'</span>%F_%H.%M<span class=\"string\">'`</span></span><br><span class=\"line\"><span class=\"string\">        [ $? -ne 0 ] &amp;&amp; &#123; echo \"没有 $grub_default_cfg 这个文件\" ; return 1; &#125;</span></span><br><span class=\"line\"><span class=\"string\">        if [ \"$Name_count\" -eq 0 ]</span></span><br><span class=\"line\"><span class=\"string\">            then</span></span><br><span class=\"line\"><span class=\"string\">            sed -ri '</span>s/(GRUB_CMDLINE_LINUX=.*quiet)/\\1 net.ifnames=0/g<span class=\"string\">' $grub_default_cfg</span></span><br><span class=\"line\"><span class=\"string\">            grub2-mkconfig -o $boot_grub</span></span><br><span class=\"line\"><span class=\"string\">            if [ $? -eq 0 ]</span></span><br><span class=\"line\"><span class=\"string\">                then</span></span><br><span class=\"line\"><span class=\"string\">                echo '</span>生成新的配置文件，生效需重启！<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">            else</span></span><br><span class=\"line\"><span class=\"string\">                echo \"grub文件生成错误！ $boot_grub 可能会产生错误！请检查\"</span></span><br><span class=\"line\"><span class=\"string\">            fi</span></span><br><span class=\"line\"><span class=\"string\">        else</span></span><br><span class=\"line\"><span class=\"string\">            echo '</span>已经修改过grub参数，无需再次修改！Do nothing！<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">        fi</span></span><br><span class=\"line\"><span class=\"string\">    else</span></span><br><span class=\"line\"><span class=\"string\">        Error_system_version</span></span><br><span class=\"line\"><span class=\"string\">    fi</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">#配置yum仓库为aliyun</span></span><br><span class=\"line\"><span class=\"string\">function Modify_yumrepo()&#123;</span></span><br><span class=\"line\"><span class=\"string\">    repo_path=/etc/yum.repos.d/</span></span><br><span class=\"line\"><span class=\"string\">    base_repo_count=`ls $repo_path | grep Alibase.repo | wc -l`</span></span><br><span class=\"line\"><span class=\"string\">    epel_repo_count=`ls $repo_path | grep epel.repo | wc -l`</span></span><br><span class=\"line\"><span class=\"string\">    mkdir -p $&#123;repo_path&#125;bak 2&gt;/dev/null</span></span><br><span class=\"line\"><span class=\"string\">    cd $repo_path</span></span><br><span class=\"line\"><span class=\"string\">    Test_network</span></span><br><span class=\"line\"><span class=\"string\">    [ $? -ne 0 ] &amp;&amp; &#123; echo '</span>网络不通,退出函数！<span class=\"string\">' ; return 1; &#125;</span></span><br><span class=\"line\"><span class=\"string\">    mv CentOS-* bak 2&gt;/dev/null</span></span><br><span class=\"line\"><span class=\"string\">    #根据系统版本添加源</span></span><br><span class=\"line\"><span class=\"string\">    if [ \"$Get_host_version\" -eq 6 ]</span></span><br><span class=\"line\"><span class=\"string\">        then</span></span><br><span class=\"line\"><span class=\"string\">        if [ \"$base_repo_count\" -eq 0 ];then</span></span><br><span class=\"line\"><span class=\"string\">            wget https://mirrors.aliyun.com/repo/Centos-6.repo -O $&#123;repo_path&#125;Alibase.repo</span></span><br><span class=\"line\"><span class=\"string\">        else</span></span><br><span class=\"line\"><span class=\"string\">            echo \"已经添加过阿里源！\"</span></span><br><span class=\"line\"><span class=\"string\">        fi</span></span><br><span class=\"line\"><span class=\"string\">        sleep 1</span></span><br><span class=\"line\"><span class=\"string\">        if [ \"$epel_repo_count\" -ne 0 ];then</span></span><br><span class=\"line\"><span class=\"string\">            wget https://mirrors.aliyun.com/repo/epel-6.repo -O $&#123;repo_path&#125;epel.repo</span></span><br><span class=\"line\"><span class=\"string\">        else</span></span><br><span class=\"line\"><span class=\"string\">            echo \"已经添加过epel源！\"</span></span><br><span class=\"line\"><span class=\"string\">        fi</span></span><br><span class=\"line\"><span class=\"string\">        yum clean all</span></span><br><span class=\"line\"><span class=\"string\">    elif [ \"$Get_host_version\" -eq 7 ]</span></span><br><span class=\"line\"><span class=\"string\">        then</span></span><br><span class=\"line\"><span class=\"string\">        if [ \"$base_repo_count\" -eq 0 ];then</span></span><br><span class=\"line\"><span class=\"string\">            wget https://mirrors.aliyun.com/repo/Centos-7.repo -O $&#123;repo_path&#125;Alibase.repo</span></span><br><span class=\"line\"><span class=\"string\">        else</span></span><br><span class=\"line\"><span class=\"string\">            echo \"已经添加过阿里源！\"</span></span><br><span class=\"line\"><span class=\"string\">        fi</span></span><br><span class=\"line\"><span class=\"string\">        sleep 1</span></span><br><span class=\"line\"><span class=\"string\">        if [ \"$epel_repo_count\" -ne 0 ];then</span></span><br><span class=\"line\"><span class=\"string\">            wget https://mirrors.aliyun.com/repo/epel-7.repo -O $&#123;repo_path&#125;epel.repo</span></span><br><span class=\"line\"><span class=\"string\">        else</span></span><br><span class=\"line\"><span class=\"string\">            echo \"已经添加过epel源！\"</span></span><br><span class=\"line\"><span class=\"string\">        fi</span></span><br><span class=\"line\"><span class=\"string\">        yum clean all   </span></span><br><span class=\"line\"><span class=\"string\">    else</span></span><br><span class=\"line\"><span class=\"string\">        Error_system_version</span></span><br><span class=\"line\"><span class=\"string\">    fi</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">#安装一些软件包</span></span><br><span class=\"line\"><span class=\"string\">function Install_some_packege()&#123;</span></span><br><span class=\"line\"><span class=\"string\">packges=\"gcc glibc zlib openssl openssl-devel lrzsz lftp ftp telnet nmap-ncat net-snmp net-snmp-devel vim sysstat bash-completion wget lsof psmisc ntp\"</span></span><br><span class=\"line\"><span class=\"string\">yum install -y $packges</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">#配置Bond</span></span><br><span class=\"line\"><span class=\"string\">function Config_Bond()&#123;</span></span><br><span class=\"line\"><span class=\"string\">    [ `ls /etc/sysconfig/network-scripts/ifcfg-Bond* 2&gt;/dev/null | wc -l ` -ne 0 ] &amp;&amp; &#123; echo '</span>已经配置了了Bond<span class=\"string\">' ; return 1; &#125;</span></span><br><span class=\"line\"><span class=\"string\">    Net_card_name=`netstat -I | sed '</span>1,2d<span class=\"string\">' | sed '</span>/lo/d<span class=\"string\">' | awk '</span>&#123;<span class=\"built_in\">print</span> <span class=\"variable\">$1</span>&#125;<span class=\"string\">'`</span></span><br><span class=\"line\"><span class=\"string\">    Net_card_Num=`netstat -I | sed '</span>1,2d<span class=\"string\">' | sed '</span>/lo/d<span class=\"string\">' | awk '</span>&#123;<span class=\"built_in\">print</span> <span class=\"variable\">$1</span>&#125;<span class=\"string\">' | wc -l`</span></span><br><span class=\"line\"><span class=\"string\">    Named_eth_count=`echo $Net_card_name | grep -io eth | wc -l`</span></span><br><span class=\"line\"><span class=\"string\">    [ \"$Named_eth_count\" -ne \"$Net_card_Num\" ] &amp;&amp; &#123; echo \"网卡名并未变更为eth，或者已经添加过了聚合类型！配置失败！\" ; return 1; &#125;</span></span><br><span class=\"line\"><span class=\"string\">    net_path=/etc/sysconfig/network-scripts/</span></span><br><span class=\"line\"><span class=\"string\">    if [ \"$Get_host_version\" == '</span>6<span class=\"string\">' ]</span></span><br><span class=\"line\"><span class=\"string\">        then</span></span><br><span class=\"line\"><span class=\"string\">        service NetworkManager stop</span></span><br><span class=\"line\"><span class=\"string\">        chkconfig NetworkManager off</span></span><br><span class=\"line\"><span class=\"string\">        for i in $Net_card_name</span></span><br><span class=\"line\"><span class=\"string\">            do</span></span><br><span class=\"line\"><span class=\"string\">            cat &gt;&gt;$&#123;net_path&#125;ifcfg-$i &lt;&lt;EOF</span></span><br><span class=\"line\"><span class=\"string\">DEVICE=$i</span></span><br><span class=\"line\"><span class=\"string\">BOOTPROTO=none</span></span><br><span class=\"line\"><span class=\"string\">MASTER=bond0</span></span><br><span class=\"line\"><span class=\"string\">SLAVE=yes        </span></span><br><span class=\"line\"><span class=\"string\">USERCTL=no</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">            done</span></span><br><span class=\"line\"><span class=\"string\">        cat &gt;&gt;$&#123;net_path&#125;ifcfg-Bond0 &lt;&lt;EOF</span></span><br><span class=\"line\"><span class=\"string\">DEVICE=bond0</span></span><br><span class=\"line\"><span class=\"string\">BOOTPROTO=none</span></span><br><span class=\"line\"><span class=\"string\">BONDING_OPTS= \"miimon=100 mode=0\"</span></span><br><span class=\"line\"><span class=\"string\">DNS1=8.8.8.8</span></span><br><span class=\"line\"><span class=\"string\">IPADDR=172.18.30.2</span></span><br><span class=\"line\"><span class=\"string\">PREFIX=16</span></span><br><span class=\"line\"><span class=\"string\">GATEWAY=172.18.0.1</span></span><br><span class=\"line\"><span class=\"string\">ONBOOT=yes</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">        service network restart</span></span><br><span class=\"line\"><span class=\"string\">    elif [ \"$Get_host_version\" == '</span>7<span class=\"string\">' ]</span></span><br><span class=\"line\"><span class=\"string\">        then</span></span><br><span class=\"line\"><span class=\"string\">        nmcli con add type bond con-name Bond0 ifname Bond0 mode 0 ipv4.method manual ipv4.addresses 172.18.30.1 ipv4.gateway 172.18.0.1 ipv4.dns 8.8.8.8 &amp;&gt;/dev/null</span></span><br><span class=\"line\"><span class=\"string\">        [ $? -eq 0 ] &amp;&amp; nmcli con up Bond0</span></span><br><span class=\"line\"><span class=\"string\">        for i in $Net_card_name</span></span><br><span class=\"line\"><span class=\"string\">            do</span></span><br><span class=\"line\"><span class=\"string\">            nmcli con add type bond-slave con-name $i-bond ifname $i master Bond0</span></span><br><span class=\"line\"><span class=\"string\">            [ $? -eq 0 ] &amp;&amp; nmcli con up $i-bond || echo \"激活失败！\"</span></span><br><span class=\"line\"><span class=\"string\">            done</span></span><br><span class=\"line\"><span class=\"string\">    else</span></span><br><span class=\"line\"><span class=\"string\">        Error_system_version</span></span><br><span class=\"line\"><span class=\"string\">    fi</span></span><br><span class=\"line\"><span class=\"string\">&#125; </span></span><br><span class=\"line\"><span class=\"string\">#这里开始调用执行</span></span><br><span class=\"line\"><span class=\"string\">Bakup_etc   #备份etc</span></span><br><span class=\"line\"><span class=\"string\">Off_firewall_and_selinux  #关闭selinux</span></span><br><span class=\"line\"><span class=\"string\">Install_wget #安装wget</span></span><br><span class=\"line\"><span class=\"string\">#Modify_charaset  #修改全局字符集</span></span><br><span class=\"line\"><span class=\"string\">Set_timezone_and_time  #设置时区和时间</span></span><br><span class=\"line\"><span class=\"string\">Set_handler_Num   # 设置打开文件数</span></span><br><span class=\"line\"><span class=\"string\">Set_tcp_kernel_arguments  #优化内核tcp连接</span></span><br><span class=\"line\"><span class=\"string\">#Modify_yumrepo   #修改yum仓库</span></span><br><span class=\"line\"><span class=\"string\">#Install_some_packege #安装一些软件包</span></span><br><span class=\"line\"><span class=\"string\">Disabled_sshd_dns #禁用ssh的dns功能</span></span><br><span class=\"line\"><span class=\"string\">#Shadow_system_version #隐藏系统版本</span></span><br><span class=\"line\"><span class=\"string\">Modify_network_card_name   #统一网卡名称为eth</span></span><br><span class=\"line\"><span class=\"string\">#Config_Bond    #配置Bond，默认ip为172.18.30.1，需要手动配置</span></span><br></pre></td></tr></table></figure>","more":"<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#********************************************************************</span></span><br><span class=\"line\"><span class=\"comment\">#encoding  -*-utf8-*-</span></span><br><span class=\"line\"><span class=\"comment\">#Author:</span></span><br><span class=\"line\"><span class=\"comment\">#Date:         2017-12-19</span></span><br><span class=\"line\"><span class=\"comment\">#URL: </span></span><br><span class=\"line\"><span class=\"comment\">#Description：  The test script</span></span><br><span class=\"line\"><span class=\"comment\">#Copyright (C):    2017 All rights reserved</span></span><br><span class=\"line\"><span class=\"comment\">#QQ Numbers:</span></span><br><span class=\"line\"><span class=\"comment\">#********************************************************************</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看系统版本 </span></span><br><span class=\"line\">Get_host_version=`cat /etc/centos-release | grep -i centos | grep -o <span class=\"string\">\"\\&lt;[[:digit:]]\\+\"</span> |head -1`</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看内核版本</span></span><br><span class=\"line\">kernel_version=`uname -r`</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#设置开机启动文件的权限,设置开机脚本</span></span><br><span class=\"line\">chmod +x /etc/rc.d/rc.local</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装wget必备工具($?上一个执行结果，$$当前进程ID)</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Install_wget</span></span>()&#123;</span><br><span class=\"line\">    mount /dev/sr0 /mnt</span><br><span class=\"line\">    [ $? -ne 0 ] &amp;&amp; &#123; <span class=\"built_in\">echo</span> <span class=\"string\">\"未添加光盘源！退出脚本\"</span> ； <span class=\"built_in\">kill</span> -9 $$ ; &#125;</span><br><span class=\"line\">    rpm -ivh /mnt/Packages/wget*</span><br><span class=\"line\">    <span class=\"built_in\">cd</span> /</span><br><span class=\"line\">    umount /mnt    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改字符集位zh_CN.UTF-8</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Modify_charaset</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">'export LANG=zh_CN.UTF-8'</span> &gt;&gt;/etc/profile</span><br><span class=\"line\">    <span class=\"built_in\">export</span> LANG=zh_CN.UTF-8</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#输出错误的系统版本</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Error_system_version</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"未知的系统版本 <span class=\"variable\">$Get_host_version</span>\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#备份操作的相关目录</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Bakup_etc</span></span>()&#123;</span><br><span class=\"line\">    Now_of_time=`date +<span class=\"string\">'%F_%H.%M'</span>`</span><br><span class=\"line\">    back_path=/bak/initsys/</span><br><span class=\"line\">    mkdir -p <span class=\"variable\">$back_path</span></span><br><span class=\"line\">    tar -czf <span class=\"variable\">$back_path</span>/etc.<span class=\"variable\">$&#123;Now_of_time&#125;</span>.tar.gz /etc</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#关闭防火墙和selinux(getenforce 获取)</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Off_firewall_and_selinux</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"comment\">#off firewall</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == 7 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        systemctl stop firewalld &amp;&gt;/dev/null</span><br><span class=\"line\">        systemctl <span class=\"built_in\">disable</span> firewalld &amp;&gt;/dev/null</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == 6 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        service iptables stop &amp;&gt;/dev/null</span><br><span class=\"line\">        chkconfig iptables off &amp;&gt;/dev/null</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">        <span class=\"built_in\">return</span> 1</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"comment\">#off selinux</span></span><br><span class=\"line\">    sed -ri <span class=\"string\">'s/^(SELINUX=).*$/\\1disabled/g'</span> /etc/selinux/config</span><br><span class=\"line\">    setenforce 0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置时区和时间</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Set_timezone_and_time</span></span>()&#123;</span><br><span class=\"line\">    /usr/bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class=\"line\">    /usr/sbin/ntpdate 10.180.4.204 <span class=\"comment\">#设置ntp服务器同步，如果需要取消注释</span></span><br><span class=\"line\">    hwclock -w <span class=\"comment\">#同步系统时间到硬件时间</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == <span class=\"string\">'6'</span> ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        cat &gt; /etc/sysconfig/clock &lt;&lt; EOF</span><br><span class=\"line\">ZONE=<span class=\"string\">\"Asia/Shanghai\"</span></span><br><span class=\"line\">UTC=<span class=\"literal\">false</span></span><br><span class=\"line\">ARC=<span class=\"literal\">false</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == <span class=\"string\">'7'</span> ] </span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        timedatectl <span class=\"built_in\">set</span>-local-rtc yes</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    <span class=\"keyword\">fi</span>    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#隐藏系统版本</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Shadow_system_version</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">''</span> &gt; /etc/issue</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">''</span> &gt; /etc/motd</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">''</span> &gt; /etc/redhat-release</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">''</span> &gt; /etc/centos-release</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#测试外网是否连通</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Test_network</span></span>()&#123;</span><br><span class=\"line\">    ping -c1 www.baidu.com &amp;&gt;/dev/null</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ $? -eq 0 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">return</span> 0</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">return</span> 1</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#设置系统最大句柄数</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Set_handler_Num</span></span>()&#123;</span><br><span class=\"line\">    limit_count=`cat /etc/security/limits.conf | grep <span class=\"string\">\"^\\*[[:blank:]]\\+\\(soft\\|hard\\)[[:blank:]]\\+\\(nofile\\|nproc\\)[[:blank:]]\\+\"</span> | wc -l`</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$limit_count</span>\"</span> -eq 0 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class=\"line\">*   soft   nofile   102400 </span><br><span class=\"line\">*   hard   nofile   102400</span><br><span class=\"line\">*   soft   nproc    40960</span><br><span class=\"line\">*   hard   nproc    40960</span><br><span class=\"line\">EOF</span><br><span class=\"line\">        <span class=\"built_in\">ulimit</span> -n 102400 <span class=\"comment\">#设置文件打开数,并马上生效，</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"已经添加过limit限制!\"</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#优化tcp连接</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Set_tcp_kernel_arguments</span></span>()&#123;</span><br><span class=\"line\">    kernel_args=/etc/sysctl.d/tcp_optimization.conf</span><br><span class=\"line\">    flag_1=`cat <span class=\"variable\">$kernel_args</span> 2&gt;/dev/null | grep tcp_flag | awk <span class=\"string\">'&#123;print $2&#125;'</span>`</span><br><span class=\"line\">    flag_2=`cat <span class=\"variable\">$kernel_args</span> 2&gt;/dev/null | grep tcp_flag | wc -l`</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$flag_2</span>\"</span> -gt 1 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"系统错误，TCP重复的优化参数，请查看 <span class=\"variable\">$kernel_args</span> 是否正确!\"</span></span><br><span class=\"line\">        <span class=\"built_in\">return</span> 1</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$flag_1</span>\"</span> == 1 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"TCP内核参数已经优化过了。\"</span></span><br><span class=\"line\">        <span class=\"built_in\">return</span> 1</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"#tcp_flag 1\"</span> &gt;&gt;<span class=\"variable\">$kernel_args</span></span><br><span class=\"line\">    touch <span class=\"variable\">$kernel_args</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_syncookies = 1\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_tw_recycle = 1\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#表示开启TCP连接中TIME-WAIT sockets的快速回收</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_tw_reuse = 1\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_fin_timeout = 5\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">##指定孤儿连接在内核中生存的时间为5秒 </span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_keepalive_time = 1200\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#表示当keepalive起用的时候，TCP发送keepalive消息的频度。缺省&gt;是2小时，改为20分钟</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.ip_local_port_range = 10000 65000\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#表示用于向外连接的端口范围</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_max_syn_backlog = 8192\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.tcp_max_tw_buckets = 5000\"</span> &gt;&gt; <span class=\"variable\">$kernel_args</span> <span class=\"comment\">#表示系统同时保持TIME_WAIT的最大数量，如果超过这个数字，TIME_WAIT将立刻被清除并打印警告信息。</span></span><br><span class=\"line\">    sysctl -p <span class=\"variable\">$kernel_args</span> &amp;&gt;/dev/null</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ $? != 0 ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">'读取Tcp内核参数错误！'</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#禁用ssh的DNS功能</span></span><br><span class=\"line\"><span class=\"comment\">#在操作中，我们都会用SSH协议来远程控制虚拟机，但是在输入用户名时候，会有一段时间的卡顿，此时正在进行SSH协议的DNS解析，我们为了快速的连接到虚拟机上，就要关闭这个解析过程</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Disabled_sshd_dns</span></span>()&#123;</span><br><span class=\"line\">    [ `grep <span class=\"string\">\"^#UseDNS \\(no\\|yes\\)\"</span> /etc/ssh/sshd_config | wc -l` -eq 0 ] &amp;&amp; &#123; <span class=\"built_in\">echo</span> <span class=\"string\">'已禁用该配置，Do nothing！'</span> ; <span class=\"built_in\">return</span> 1; &#125;</span><br><span class=\"line\">    sed -ri <span class=\"string\">'s@#UseDNS (no|yes)@UseDNS no@g'</span> /etc/ssh/sshd_config</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == <span class=\"string\">'6'</span> ]</span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        service sshd restart</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == <span class=\"string\">'7'</span> ] </span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        systemctl restart sshd</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置网卡名称为eth*</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Modify_network_card_name</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$Get_host_version</span>\"</span> == <span class=\"string\">'6'</span> ] <span class=\"comment\">#修改Centos6 的网卡</span></span><br><span class=\"line\">        <span class=\"keyword\">then</span></span><br><span class=\"line\">        Count_cart=`cat /etc/udev/rules.d/70-persistent-net.rules | grep <span class=\"string\">'SUBSYSTEM==\"net\", ACTION==\"add\"'</span> | wc -l`</span><br><span class=\"line\">        [ <span class=\"string\">\"<span class=\"variable\">$Count_cart</span>\"</span> -eq 0 ] &amp;&amp; &#123; <span class=\"built_in\">echo</span> <span class=\"string\">\"没有网卡信息，请检查网卡驱动！\"</span> ; <span class=\"built_in\">return</span> 1; &#125;</span><br><span class=\"line\">        count=1</span><br><span class=\"line\">        All_mac=`cat 70-persistent-net.rules | grep <span class=\"string\">'SUBSYSTEM==\"net\", ACTION==\"add\"'</span> |grep -o <span class=\"string\">\"\\([0-9a-fA-F]\\&#123;2\\&#125;:\\)\\&#123;5\\&#125;[0-9a-fA-F]\\&#123;2\\&#125;\"</span>`</span><br><span class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"variable\">$ALL_mac</span>`</span><br><span class=\"line\">            <span class=\"keyword\">do</span></span><br><span class=\"line\">            sed -ri <span class=\"string\">'s@('</span><span class=\"variable\">$i</span><span class=\"string\">'.*NAME=\").*[[:digit:]]+\"$@\\1eth'</span><span class=\"variable\">$count</span><span class=\"string\">'$\"@'</span> /etc/udev/rules.d/70-persistent-net.rules</span><br><span class=\"line\">            <span class=\"built_in\">let</span> count+=1</span><br><span class=\"line\">            <span class=\"keyword\">done</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">'修改网卡名成功,请查看配置!'</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"`cat /etc/udev/rules.d/70-persistent-net.rules | grep 'SUBSYSTEM==\"</span>net<span class=\"string\">\", ACTION==\"</span>add<span class=\"string\">\", DRIVERS==\"</span>?*<span class=\"string\">\", ATTR&#123;address&#125;==\"</span><span class=\"string\">'`\"</span></span><br><span class=\"line\"><span class=\"string\">    elif [ \"$Get_host_version\" == '</span>7<span class=\"string\">' ] #修改Centos7 的网卡</span></span><br><span class=\"line\"><span class=\"string\">        then</span></span><br><span class=\"line\"><span class=\"string\">        boot_grub=/boot/grub2/grub.cfg</span></span><br><span class=\"line\"><span class=\"string\">        grub_default_cfg=/etc/default/grub</span></span><br><span class=\"line\"><span class=\"string\">        Name_count=`cat  $boot_grub 2&gt;/dev/null | grep \"quiet[[:blank:]]\\+net.ifnames\" | wc -l`</span></span><br><span class=\"line\"><span class=\"string\">        cp $grub_default_cfg $&#123;grub_default_cfg&#125;.`date +'</span>%F_%H.%M<span class=\"string\">'`</span></span><br><span class=\"line\"><span class=\"string\">        [ $? -ne 0 ] &amp;&amp; &#123; echo \"没有 $grub_default_cfg 这个文件\" ; return 1; &#125;</span></span><br><span class=\"line\"><span class=\"string\">        if [ \"$Name_count\" -eq 0 ]</span></span><br><span class=\"line\"><span class=\"string\">            then</span></span><br><span class=\"line\"><span class=\"string\">            sed -ri '</span>s/(GRUB_CMDLINE_LINUX=.*quiet)/\\1 net.ifnames=0/g<span class=\"string\">' $grub_default_cfg</span></span><br><span class=\"line\"><span class=\"string\">            grub2-mkconfig -o $boot_grub</span></span><br><span class=\"line\"><span class=\"string\">            if [ $? -eq 0 ]</span></span><br><span class=\"line\"><span class=\"string\">                then</span></span><br><span class=\"line\"><span class=\"string\">                echo '</span>生成新的配置文件，生效需重启！<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">            else</span></span><br><span class=\"line\"><span class=\"string\">                echo \"grub文件生成错误！ $boot_grub 可能会产生错误！请检查\"</span></span><br><span class=\"line\"><span class=\"string\">            fi</span></span><br><span class=\"line\"><span class=\"string\">        else</span></span><br><span class=\"line\"><span class=\"string\">            echo '</span>已经修改过grub参数，无需再次修改！Do nothing！<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">        fi</span></span><br><span class=\"line\"><span class=\"string\">    else</span></span><br><span class=\"line\"><span class=\"string\">        Error_system_version</span></span><br><span class=\"line\"><span class=\"string\">    fi</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">#配置yum仓库为aliyun</span></span><br><span class=\"line\"><span class=\"string\">function Modify_yumrepo()&#123;</span></span><br><span class=\"line\"><span class=\"string\">    repo_path=/etc/yum.repos.d/</span></span><br><span class=\"line\"><span class=\"string\">    base_repo_count=`ls $repo_path | grep Alibase.repo | wc -l`</span></span><br><span class=\"line\"><span class=\"string\">    epel_repo_count=`ls $repo_path | grep epel.repo | wc -l`</span></span><br><span class=\"line\"><span class=\"string\">    mkdir -p $&#123;repo_path&#125;bak 2&gt;/dev/null</span></span><br><span class=\"line\"><span class=\"string\">    cd $repo_path</span></span><br><span class=\"line\"><span class=\"string\">    Test_network</span></span><br><span class=\"line\"><span class=\"string\">    [ $? -ne 0 ] &amp;&amp; &#123; echo '</span>网络不通,退出函数！<span class=\"string\">' ; return 1; &#125;</span></span><br><span class=\"line\"><span class=\"string\">    mv CentOS-* bak 2&gt;/dev/null</span></span><br><span class=\"line\"><span class=\"string\">    #根据系统版本添加源</span></span><br><span class=\"line\"><span class=\"string\">    if [ \"$Get_host_version\" -eq 6 ]</span></span><br><span class=\"line\"><span class=\"string\">        then</span></span><br><span class=\"line\"><span class=\"string\">        if [ \"$base_repo_count\" -eq 0 ];then</span></span><br><span class=\"line\"><span class=\"string\">            wget https://mirrors.aliyun.com/repo/Centos-6.repo -O $&#123;repo_path&#125;Alibase.repo</span></span><br><span class=\"line\"><span class=\"string\">        else</span></span><br><span class=\"line\"><span class=\"string\">            echo \"已经添加过阿里源！\"</span></span><br><span class=\"line\"><span class=\"string\">        fi</span></span><br><span class=\"line\"><span class=\"string\">        sleep 1</span></span><br><span class=\"line\"><span class=\"string\">        if [ \"$epel_repo_count\" -ne 0 ];then</span></span><br><span class=\"line\"><span class=\"string\">            wget https://mirrors.aliyun.com/repo/epel-6.repo -O $&#123;repo_path&#125;epel.repo</span></span><br><span class=\"line\"><span class=\"string\">        else</span></span><br><span class=\"line\"><span class=\"string\">            echo \"已经添加过epel源！\"</span></span><br><span class=\"line\"><span class=\"string\">        fi</span></span><br><span class=\"line\"><span class=\"string\">        yum clean all</span></span><br><span class=\"line\"><span class=\"string\">    elif [ \"$Get_host_version\" -eq 7 ]</span></span><br><span class=\"line\"><span class=\"string\">        then</span></span><br><span class=\"line\"><span class=\"string\">        if [ \"$base_repo_count\" -eq 0 ];then</span></span><br><span class=\"line\"><span class=\"string\">            wget https://mirrors.aliyun.com/repo/Centos-7.repo -O $&#123;repo_path&#125;Alibase.repo</span></span><br><span class=\"line\"><span class=\"string\">        else</span></span><br><span class=\"line\"><span class=\"string\">            echo \"已经添加过阿里源！\"</span></span><br><span class=\"line\"><span class=\"string\">        fi</span></span><br><span class=\"line\"><span class=\"string\">        sleep 1</span></span><br><span class=\"line\"><span class=\"string\">        if [ \"$epel_repo_count\" -ne 0 ];then</span></span><br><span class=\"line\"><span class=\"string\">            wget https://mirrors.aliyun.com/repo/epel-7.repo -O $&#123;repo_path&#125;epel.repo</span></span><br><span class=\"line\"><span class=\"string\">        else</span></span><br><span class=\"line\"><span class=\"string\">            echo \"已经添加过epel源！\"</span></span><br><span class=\"line\"><span class=\"string\">        fi</span></span><br><span class=\"line\"><span class=\"string\">        yum clean all   </span></span><br><span class=\"line\"><span class=\"string\">    else</span></span><br><span class=\"line\"><span class=\"string\">        Error_system_version</span></span><br><span class=\"line\"><span class=\"string\">    fi</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">#安装一些软件包</span></span><br><span class=\"line\"><span class=\"string\">function Install_some_packege()&#123;</span></span><br><span class=\"line\"><span class=\"string\">packges=\"gcc glibc zlib openssl openssl-devel lrzsz lftp ftp telnet nmap-ncat net-snmp net-snmp-devel vim sysstat bash-completion wget lsof psmisc ntp\"</span></span><br><span class=\"line\"><span class=\"string\">yum install -y $packges</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">#配置Bond</span></span><br><span class=\"line\"><span class=\"string\">function Config_Bond()&#123;</span></span><br><span class=\"line\"><span class=\"string\">    [ `ls /etc/sysconfig/network-scripts/ifcfg-Bond* 2&gt;/dev/null | wc -l ` -ne 0 ] &amp;&amp; &#123; echo '</span>已经配置了了Bond<span class=\"string\">' ; return 1; &#125;</span></span><br><span class=\"line\"><span class=\"string\">    Net_card_name=`netstat -I | sed '</span>1,2d<span class=\"string\">' | sed '</span>/lo/d<span class=\"string\">' | awk '</span>&#123;<span class=\"built_in\">print</span> <span class=\"variable\">$1</span>&#125;<span class=\"string\">'`</span></span><br><span class=\"line\"><span class=\"string\">    Net_card_Num=`netstat -I | sed '</span>1,2d<span class=\"string\">' | sed '</span>/lo/d<span class=\"string\">' | awk '</span>&#123;<span class=\"built_in\">print</span> <span class=\"variable\">$1</span>&#125;<span class=\"string\">' | wc -l`</span></span><br><span class=\"line\"><span class=\"string\">    Named_eth_count=`echo $Net_card_name | grep -io eth | wc -l`</span></span><br><span class=\"line\"><span class=\"string\">    [ \"$Named_eth_count\" -ne \"$Net_card_Num\" ] &amp;&amp; &#123; echo \"网卡名并未变更为eth，或者已经添加过了聚合类型！配置失败！\" ; return 1; &#125;</span></span><br><span class=\"line\"><span class=\"string\">    net_path=/etc/sysconfig/network-scripts/</span></span><br><span class=\"line\"><span class=\"string\">    if [ \"$Get_host_version\" == '</span>6<span class=\"string\">' ]</span></span><br><span class=\"line\"><span class=\"string\">        then</span></span><br><span class=\"line\"><span class=\"string\">        service NetworkManager stop</span></span><br><span class=\"line\"><span class=\"string\">        chkconfig NetworkManager off</span></span><br><span class=\"line\"><span class=\"string\">        for i in $Net_card_name</span></span><br><span class=\"line\"><span class=\"string\">            do</span></span><br><span class=\"line\"><span class=\"string\">            cat &gt;&gt;$&#123;net_path&#125;ifcfg-$i &lt;&lt;EOF</span></span><br><span class=\"line\"><span class=\"string\">DEVICE=$i</span></span><br><span class=\"line\"><span class=\"string\">BOOTPROTO=none</span></span><br><span class=\"line\"><span class=\"string\">MASTER=bond0</span></span><br><span class=\"line\"><span class=\"string\">SLAVE=yes        </span></span><br><span class=\"line\"><span class=\"string\">USERCTL=no</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">            done</span></span><br><span class=\"line\"><span class=\"string\">        cat &gt;&gt;$&#123;net_path&#125;ifcfg-Bond0 &lt;&lt;EOF</span></span><br><span class=\"line\"><span class=\"string\">DEVICE=bond0</span></span><br><span class=\"line\"><span class=\"string\">BOOTPROTO=none</span></span><br><span class=\"line\"><span class=\"string\">BONDING_OPTS= \"miimon=100 mode=0\"</span></span><br><span class=\"line\"><span class=\"string\">DNS1=8.8.8.8</span></span><br><span class=\"line\"><span class=\"string\">IPADDR=172.18.30.2</span></span><br><span class=\"line\"><span class=\"string\">PREFIX=16</span></span><br><span class=\"line\"><span class=\"string\">GATEWAY=172.18.0.1</span></span><br><span class=\"line\"><span class=\"string\">ONBOOT=yes</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">        service network restart</span></span><br><span class=\"line\"><span class=\"string\">    elif [ \"$Get_host_version\" == '</span>7<span class=\"string\">' ]</span></span><br><span class=\"line\"><span class=\"string\">        then</span></span><br><span class=\"line\"><span class=\"string\">        nmcli con add type bond con-name Bond0 ifname Bond0 mode 0 ipv4.method manual ipv4.addresses 172.18.30.1 ipv4.gateway 172.18.0.1 ipv4.dns 8.8.8.8 &amp;&gt;/dev/null</span></span><br><span class=\"line\"><span class=\"string\">        [ $? -eq 0 ] &amp;&amp; nmcli con up Bond0</span></span><br><span class=\"line\"><span class=\"string\">        for i in $Net_card_name</span></span><br><span class=\"line\"><span class=\"string\">            do</span></span><br><span class=\"line\"><span class=\"string\">            nmcli con add type bond-slave con-name $i-bond ifname $i master Bond0</span></span><br><span class=\"line\"><span class=\"string\">            [ $? -eq 0 ] &amp;&amp; nmcli con up $i-bond || echo \"激活失败！\"</span></span><br><span class=\"line\"><span class=\"string\">            done</span></span><br><span class=\"line\"><span class=\"string\">    else</span></span><br><span class=\"line\"><span class=\"string\">        Error_system_version</span></span><br><span class=\"line\"><span class=\"string\">    fi</span></span><br><span class=\"line\"><span class=\"string\">&#125; </span></span><br><span class=\"line\"><span class=\"string\">#这里开始调用执行</span></span><br><span class=\"line\"><span class=\"string\">Bakup_etc   #备份etc</span></span><br><span class=\"line\"><span class=\"string\">Off_firewall_and_selinux  #关闭selinux</span></span><br><span class=\"line\"><span class=\"string\">Install_wget #安装wget</span></span><br><span class=\"line\"><span class=\"string\">#Modify_charaset  #修改全局字符集</span></span><br><span class=\"line\"><span class=\"string\">Set_timezone_and_time  #设置时区和时间</span></span><br><span class=\"line\"><span class=\"string\">Set_handler_Num   # 设置打开文件数</span></span><br><span class=\"line\"><span class=\"string\">Set_tcp_kernel_arguments  #优化内核tcp连接</span></span><br><span class=\"line\"><span class=\"string\">#Modify_yumrepo   #修改yum仓库</span></span><br><span class=\"line\"><span class=\"string\">#Install_some_packege #安装一些软件包</span></span><br><span class=\"line\"><span class=\"string\">Disabled_sshd_dns #禁用ssh的dns功能</span></span><br><span class=\"line\"><span class=\"string\">#Shadow_system_version #隐藏系统版本</span></span><br><span class=\"line\"><span class=\"string\">Modify_network_card_name   #统一网卡名称为eth</span></span><br><span class=\"line\"><span class=\"string\">#Config_Bond    #配置Bond，默认ip为172.18.30.1，需要手动配置</span></span><br></pre></td></tr></table></figure>","categories":[{"name":"shell脚本","path":"api/categories/shell脚本.json"}],"tags":[{"name":"shell脚本","path":"api/tags/shell脚本.json"}]}