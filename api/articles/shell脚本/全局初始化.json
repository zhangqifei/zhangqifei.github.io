{"title":"全局初始化","slug":"shell脚本/全局初始化","date":"2019-06-28T03:50:51.840Z","updated":"2019-06-28T03:57:51.478Z","comments":true,"path":"api/articles/shell脚本/全局初始化.json","excerpt":null,"covers":null,"content":"<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">#</span><br><span class=\"line\">#********************************************************************</span><br><span class=\"line\">#encoding  -*-utf8-*-</span><br><span class=\"line\">#Author:</span><br><span class=\"line\">#Date:         2017-12-19</span><br><span class=\"line\">#URL: </span><br><span class=\"line\">#Description：  The test script</span><br><span class=\"line\">#Copyright (C):    2017 All rights reserved</span><br><span class=\"line\">#QQ Numbers:</span><br><span class=\"line\">#********************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">#查看系统版本 </span><br><span class=\"line\">Get_host_version=`cat /etc/centos-release | grep -i centos | grep -o &quot;\\&lt;[[:digit:]]\\+&quot; |head -1`</span><br><span class=\"line\"></span><br><span class=\"line\">#查看内核版本</span><br><span class=\"line\">kernel_version=`uname -r`</span><br><span class=\"line\"></span><br><span class=\"line\">#设置开机启动文件的权限,设置开机脚本</span><br><span class=\"line\">chmod +x /etc/rc.d/rc.local</span><br><span class=\"line\"></span><br><span class=\"line\">#安装wget必备工具($?上一个执行结果，$$当前进程ID)</span><br><span class=\"line\">function Install_wget()&#123;</span><br><span class=\"line\">    mount /dev/sr0 /mnt</span><br><span class=\"line\">    [ $? -ne 0 ] &amp;&amp; &#123; echo &quot;未添加光盘源！退出脚本&quot; ； kill -9 $$ ; &#125;</span><br><span class=\"line\">    rpm -ivh /mnt/Packages/wget*</span><br><span class=\"line\">    cd /</span><br><span class=\"line\">    umount /mnt    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#修改字符集位zh_CN.UTF-8</span><br><span class=\"line\">function Modify_charaset()&#123;</span><br><span class=\"line\">    echo &apos;export LANG=zh_CN.UTF-8&apos; &gt;&gt;/etc/profile</span><br><span class=\"line\">    export LANG=zh_CN.UTF-8</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#输出错误的系统版本</span><br><span class=\"line\">function Error_system_version()&#123;</span><br><span class=\"line\">    echo &quot;未知的系统版本 $Get_host_version&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#备份操作的相关目录</span><br><span class=\"line\">function Bakup_etc()&#123;</span><br><span class=\"line\">    Now_of_time=`date +&apos;%F_%H.%M&apos;`</span><br><span class=\"line\">    back_path=/bak/initsys/</span><br><span class=\"line\">    mkdir -p $back_path</span><br><span class=\"line\">    tar -czf $back_path/etc.$&#123;Now_of_time&#125;.tar.gz /etc</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#关闭防火墙和selinux(getenforce 获取)</span><br><span class=\"line\">function Off_firewall_and_selinux()&#123;</span><br><span class=\"line\">    #off firewall</span><br><span class=\"line\">    if [ &quot;$Get_host_version&quot; == 7 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        systemctl stop firewalld &amp;&gt;/dev/null</span><br><span class=\"line\">        systemctl disable firewalld &amp;&gt;/dev/null</span><br><span class=\"line\">    elif [ &quot;$Get_host_version&quot; == 6 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        service iptables stop &amp;&gt;/dev/null</span><br><span class=\"line\">        chkconfig iptables off &amp;&gt;/dev/null</span><br><span class=\"line\">    else</span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    #off selinux</span><br><span class=\"line\">    sed -ri &apos;s/^(SELINUX=).*$/\\1disabled/g&apos; /etc/selinux/config</span><br><span class=\"line\">    setenforce 0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#配置时区和时间</span><br><span class=\"line\">function Set_timezone_and_time()&#123;</span><br><span class=\"line\">    /usr/bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class=\"line\">    /usr/sbin/ntpdate 10.180.4.204 #设置ntp服务器同步，如果需要取消注释</span><br><span class=\"line\">    hwclock -w #同步系统时间到硬件时间</span><br><span class=\"line\">    if [ &quot;$Get_host_version&quot; == &apos;6&apos; ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        cat &gt; /etc/sysconfig/clock &lt;&lt; EOF</span><br><span class=\"line\">ZONE=&quot;Asia/Shanghai&quot;</span><br><span class=\"line\">UTC=false</span><br><span class=\"line\">ARC=false</span><br><span class=\"line\">EOF</span><br><span class=\"line\">    elif [ &quot;$Get_host_version&quot; == &apos;7&apos; ] </span><br><span class=\"line\">        then</span><br><span class=\"line\">        timedatectl set-local-rtc yes</span><br><span class=\"line\">    else</span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    fi    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#隐藏系统版本</span><br><span class=\"line\">function Shadow_system_version()&#123;</span><br><span class=\"line\">    echo &apos;&apos; &gt; /etc/issue</span><br><span class=\"line\">    echo &apos;&apos; &gt; /etc/motd</span><br><span class=\"line\">    echo &apos;&apos; &gt; /etc/redhat-release</span><br><span class=\"line\">    echo &apos;&apos; &gt; /etc/centos-release</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#测试外网是否连通</span><br><span class=\"line\">function Test_network()&#123;</span><br><span class=\"line\">    ping -c1 www.baidu.com &amp;&gt;/dev/null</span><br><span class=\"line\">    if [ $? -eq 0 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        return 0</span><br><span class=\"line\">    else</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#设置系统最大句柄数</span><br><span class=\"line\">function Set_handler_Num()&#123;</span><br><span class=\"line\">    limit_count=`cat /etc/security/limits.conf | grep &quot;^\\*[[:blank:]]\\+\\(soft\\|hard\\)[[:blank:]]\\+\\(nofile\\|nproc\\)[[:blank:]]\\+&quot; | wc -l`</span><br><span class=\"line\">    if [ &quot;$limit_count&quot; -eq 0 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class=\"line\">*   soft   nofile   102400 </span><br><span class=\"line\">*   hard   nofile   102400</span><br><span class=\"line\">*   soft   nproc    40960</span><br><span class=\"line\">*   hard   nproc    40960</span><br><span class=\"line\">EOF</span><br><span class=\"line\">        ulimit -n 102400 #设置文件打开数,并马上生效，</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo &quot;已经添加过limit限制!&quot;</span><br><span class=\"line\">    fi</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#优化tcp连接</span><br><span class=\"line\">function Set_tcp_kernel_arguments()&#123;</span><br><span class=\"line\">    kernel_args=/etc/sysctl.d/tcp_optimization.conf</span><br><span class=\"line\">    flag_1=`cat $kernel_args 2&gt;/dev/null | grep tcp_flag | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class=\"line\">    flag_2=`cat $kernel_args 2&gt;/dev/null | grep tcp_flag | wc -l`</span><br><span class=\"line\">    if [ &quot;$flag_2&quot; -gt 1 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        echo &quot;系统错误，TCP重复的优化参数，请查看 $kernel_args 是否正确!&quot;</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    if [ &quot;$flag_1&quot; == 1 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        echo &quot;TCP内核参数已经优化过了。&quot;</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    echo &quot;#tcp_flag 1&quot; &gt;&gt;$kernel_args</span><br><span class=\"line\">    touch $kernel_args</span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_syncookies = 1&quot; &gt;&gt; $kernel_args #开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击</span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_tw_recycle = 1&quot; &gt;&gt; $kernel_args #表示开启TCP连接中TIME-WAIT sockets的快速回收</span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_tw_reuse = 1&quot; &gt;&gt; $kernel_args #表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接</span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_fin_timeout = 5&quot; &gt;&gt; $kernel_args ##指定孤儿连接在内核中生存的时间为5秒 </span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_keepalive_time = 1200&quot; &gt;&gt; $kernel_args #表示当keepalive起用的时候，TCP发送keepalive消息的频度。缺省&gt;是2小时，改为20分钟</span><br><span class=\"line\">    echo &quot;net.ipv4.ip_local_port_range = 10000 65000&quot; &gt;&gt; $kernel_args #表示用于向外连接的端口范围</span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_max_syn_backlog = 8192&quot; &gt;&gt; $kernel_args #表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数</span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_max_tw_buckets = 5000&quot; &gt;&gt; $kernel_args #表示系统同时保持TIME_WAIT的最大数量，如果超过这个数字，TIME_WAIT将立刻被清除并打印警告信息。</span><br><span class=\"line\">    sysctl -p $kernel_args &amp;&gt;/dev/null</span><br><span class=\"line\">    if [ $? != 0 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        echo &apos;读取Tcp内核参数错误！&apos;</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#禁用ssh的DNS功能</span><br><span class=\"line\">#在操作中，我们都会用SSH协议来远程控制虚拟机，但是在输入用户名时候，会有一段时间的卡顿，此时正在进行SSH协议的DNS解析，我们为了快速的连接到虚拟机上，就要关闭这个解析过程</span><br><span class=\"line\">function Disabled_sshd_dns()&#123;</span><br><span class=\"line\">    [ `grep &quot;^#UseDNS \\(no\\|yes\\)&quot; /etc/ssh/sshd_config | wc -l` -eq 0 ] &amp;&amp; &#123; echo &apos;已禁用该配置，Do nothing！&apos; ; return 1; &#125;</span><br><span class=\"line\">    sed -ri &apos;s@#UseDNS (no|yes)@UseDNS no@g&apos; /etc/ssh/sshd_config</span><br><span class=\"line\">    if [ &quot;$Get_host_version&quot; == &apos;6&apos; ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        service sshd restart</span><br><span class=\"line\">    elif [ &quot;$Get_host_version&quot; == &apos;7&apos; ] </span><br><span class=\"line\">        then</span><br><span class=\"line\">        systemctl restart sshd</span><br><span class=\"line\">    else</span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#配置网卡名称为eth*</span><br><span class=\"line\">function Modify_network_card_name()&#123;</span><br><span class=\"line\">    if [ &quot;$Get_host_version&quot; == &apos;6&apos; ] #修改Centos6 的网卡</span><br><span class=\"line\">        then</span><br><span class=\"line\">        Count_cart=`cat /etc/udev/rules.d/70-persistent-net.rules | grep &apos;SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;&apos; | wc -l`</span><br><span class=\"line\">        [ &quot;$Count_cart&quot; -eq 0 ] &amp;&amp; &#123; echo &quot;没有网卡信息，请检查网卡驱动！&quot; ; return 1; &#125;</span><br><span class=\"line\">        count=1</span><br><span class=\"line\">        All_mac=`cat 70-persistent-net.rules | grep &apos;SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;&apos; |grep -o &quot;\\([0-9a-fA-F]\\&#123;2\\&#125;:\\)\\&#123;5\\&#125;[0-9a-fA-F]\\&#123;2\\&#125;&quot;`</span><br><span class=\"line\">        for i in `$ALL_mac`</span><br><span class=\"line\">            do</span><br><span class=\"line\">            sed -ri &apos;s@(&apos;$i&apos;.*NAME=&quot;).*[[:digit:]]+&quot;$@\\1eth&apos;$count&apos;$&quot;@&apos; /etc/udev/rules.d/70-persistent-net.rules</span><br><span class=\"line\">            let count+=1</span><br><span class=\"line\">            done</span><br><span class=\"line\">        echo &apos;修改网卡名成功,请查看配置!&apos;</span><br><span class=\"line\">        echo &quot;`cat /etc/udev/rules.d/70-persistent-net.rules | grep &apos;SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?*&quot;, ATTR&#123;address&#125;==&quot;&apos;`&quot;</span><br><span class=\"line\">    elif [ &quot;$Get_host_version&quot; == &apos;7&apos; ] #修改Centos7 的网卡</span><br><span class=\"line\">        then</span><br><span class=\"line\">        boot_grub=/boot/grub2/grub.cfg</span><br><span class=\"line\">        grub_default_cfg=/etc/default/grub</span><br><span class=\"line\">        Name_count=`cat  $boot_grub 2&gt;/dev/null | grep &quot;quiet[[:blank:]]\\+net.ifnames&quot; | wc -l`</span><br><span class=\"line\">        cp $grub_default_cfg $&#123;grub_default_cfg&#125;.`date +&apos;%F_%H.%M&apos;`</span><br><span class=\"line\">        [ $? -ne 0 ] &amp;&amp; &#123; echo &quot;没有 $grub_default_cfg 这个文件&quot; ; return 1; &#125;</span><br><span class=\"line\">        if [ &quot;$Name_count&quot; -eq 0 ]</span><br><span class=\"line\">            then</span><br><span class=\"line\">            sed -ri &apos;s/(GRUB_CMDLINE_LINUX=.*quiet)/\\1 net.ifnames=0/g&apos; $grub_default_cfg</span><br><span class=\"line\">            grub2-mkconfig -o $boot_grub</span><br><span class=\"line\">            if [ $? -eq 0 ]</span><br><span class=\"line\">                then</span><br><span class=\"line\">                echo &apos;生成新的配置文件，生效需重启！&apos;</span><br><span class=\"line\">            else</span><br><span class=\"line\">                echo &quot;grub文件生成错误！ $boot_grub 可能会产生错误！请检查&quot;</span><br><span class=\"line\">            fi</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo &apos;已经修改过grub参数，无需再次修改！Do nothing！&apos;</span><br><span class=\"line\">        fi</span><br><span class=\"line\">    else</span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#配置yum仓库为aliyun</span><br><span class=\"line\">function Modify_yumrepo()&#123;</span><br><span class=\"line\">    repo_path=/etc/yum.repos.d/</span><br><span class=\"line\">    base_repo_count=`ls $repo_path | grep Alibase.repo | wc -l`</span><br><span class=\"line\">    epel_repo_count=`ls $repo_path | grep epel.repo | wc -l`</span><br><span class=\"line\">    mkdir -p $&#123;repo_path&#125;bak 2&gt;/dev/null</span><br><span class=\"line\">    cd $repo_path</span><br><span class=\"line\">    Test_network</span><br><span class=\"line\">    [ $? -ne 0 ] &amp;&amp; &#123; echo &apos;网络不通,退出函数！&apos; ; return 1; &#125;</span><br><span class=\"line\">    mv CentOS-* bak 2&gt;/dev/null</span><br><span class=\"line\">    #根据系统版本添加源</span><br><span class=\"line\">    if [ &quot;$Get_host_version&quot; -eq 6 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        if [ &quot;$base_repo_count&quot; -eq 0 ];then</span><br><span class=\"line\">            wget https://mirrors.aliyun.com/repo/Centos-6.repo -O $&#123;repo_path&#125;Alibase.repo</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo &quot;已经添加过阿里源！&quot;</span><br><span class=\"line\">        fi</span><br><span class=\"line\">        sleep 1</span><br><span class=\"line\">        if [ &quot;$epel_repo_count&quot; -ne 0 ];then</span><br><span class=\"line\">            wget https://mirrors.aliyun.com/repo/epel-6.repo -O $&#123;repo_path&#125;epel.repo</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo &quot;已经添加过epel源！&quot;</span><br><span class=\"line\">        fi</span><br><span class=\"line\">        yum clean all</span><br><span class=\"line\">    elif [ &quot;$Get_host_version&quot; -eq 7 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        if [ &quot;$base_repo_count&quot; -eq 0 ];then</span><br><span class=\"line\">            wget https://mirrors.aliyun.com/repo/Centos-7.repo -O $&#123;repo_path&#125;Alibase.repo</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo &quot;已经添加过阿里源！&quot;</span><br><span class=\"line\">        fi</span><br><span class=\"line\">        sleep 1</span><br><span class=\"line\">        if [ &quot;$epel_repo_count&quot; -ne 0 ];then</span><br><span class=\"line\">            wget https://mirrors.aliyun.com/repo/epel-7.repo -O $&#123;repo_path&#125;epel.repo</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo &quot;已经添加过epel源！&quot;</span><br><span class=\"line\">        fi</span><br><span class=\"line\">        yum clean all   </span><br><span class=\"line\">    else</span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#安装一些软件包</span><br><span class=\"line\">function Install_some_packege()&#123;</span><br><span class=\"line\">packges=&quot;gcc glibc zlib openssl openssl-devel lrzsz lftp ftp telnet nmap-ncat net-snmp net-snmp-devel vim sysstat bash-completion wget lsof psmisc ntp&quot;</span><br><span class=\"line\">yum install -y $packges</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#配置Bond</span><br><span class=\"line\">function Config_Bond()&#123;</span><br><span class=\"line\">    [ `ls /etc/sysconfig/network-scripts/ifcfg-Bond* 2&gt;/dev/null | wc -l ` -ne 0 ] &amp;&amp; &#123; echo &apos;已经配置了了Bond&apos; ; return 1; &#125;</span><br><span class=\"line\">    Net_card_name=`netstat -I | sed &apos;1,2d&apos; | sed &apos;/lo/d&apos; | awk &apos;&#123;print $1&#125;&apos;`</span><br><span class=\"line\">    Net_card_Num=`netstat -I | sed &apos;1,2d&apos; | sed &apos;/lo/d&apos; | awk &apos;&#123;print $1&#125;&apos; | wc -l`</span><br><span class=\"line\">    Named_eth_count=`echo $Net_card_name | grep -io eth | wc -l`</span><br><span class=\"line\">    [ &quot;$Named_eth_count&quot; -ne &quot;$Net_card_Num&quot; ] &amp;&amp; &#123; echo &quot;网卡名并未变更为eth，或者已经添加过了聚合类型！配置失败！&quot; ; return 1; &#125;</span><br><span class=\"line\">    net_path=/etc/sysconfig/network-scripts/</span><br><span class=\"line\">    if [ &quot;$Get_host_version&quot; == &apos;6&apos; ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        service NetworkManager stop</span><br><span class=\"line\">        chkconfig NetworkManager off</span><br><span class=\"line\">        for i in $Net_card_name</span><br><span class=\"line\">            do</span><br><span class=\"line\">            cat &gt;&gt;$&#123;net_path&#125;ifcfg-$i &lt;&lt;EOF</span><br><span class=\"line\">DEVICE=$i</span><br><span class=\"line\">BOOTPROTO=none</span><br><span class=\"line\">MASTER=bond0</span><br><span class=\"line\">SLAVE=yes        </span><br><span class=\"line\">USERCTL=no</span><br><span class=\"line\">EOF</span><br><span class=\"line\">            done</span><br><span class=\"line\">        cat &gt;&gt;$&#123;net_path&#125;ifcfg-Bond0 &lt;&lt;EOF</span><br><span class=\"line\">DEVICE=bond0</span><br><span class=\"line\">BOOTPROTO=none</span><br><span class=\"line\">BONDING_OPTS= &quot;miimon=100 mode=0&quot;</span><br><span class=\"line\">DNS1=8.8.8.8</span><br><span class=\"line\">IPADDR=172.18.30.2</span><br><span class=\"line\">PREFIX=16</span><br><span class=\"line\">GATEWAY=172.18.0.1</span><br><span class=\"line\">ONBOOT=yes</span><br><span class=\"line\">EOF</span><br><span class=\"line\">        service network restart</span><br><span class=\"line\">    elif [ &quot;$Get_host_version&quot; == &apos;7&apos; ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        nmcli con add type bond con-name Bond0 ifname Bond0 mode 0 ipv4.method manual ipv4.addresses 172.18.30.1 ipv4.gateway 172.18.0.1 ipv4.dns 8.8.8.8 &amp;&gt;/dev/null</span><br><span class=\"line\">        [ $? -eq 0 ] &amp;&amp; nmcli con up Bond0</span><br><span class=\"line\">        for i in $Net_card_name</span><br><span class=\"line\">            do</span><br><span class=\"line\">            nmcli con add type bond-slave con-name $i-bond ifname $i master Bond0</span><br><span class=\"line\">            [ $? -eq 0 ] &amp;&amp; nmcli con up $i-bond || echo &quot;激活失败！&quot;</span><br><span class=\"line\">            done</span><br><span class=\"line\">    else</span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125; </span><br><span class=\"line\">#这里开始调用执行</span><br><span class=\"line\">Bakup_etc   #备份etc</span><br><span class=\"line\">Off_firewall_and_selinux  #关闭selinux</span><br><span class=\"line\">Install_wget #安装wget</span><br><span class=\"line\">#Modify_charaset  #修改全局字符集</span><br><span class=\"line\">Set_timezone_and_time  #设置时区和时间</span><br><span class=\"line\">Set_handler_Num   # 设置打开文件数</span><br><span class=\"line\">Set_tcp_kernel_arguments  #优化内核tcp连接</span><br><span class=\"line\">#Modify_yumrepo   #修改yum仓库</span><br><span class=\"line\">#Install_some_packege #安装一些软件包</span><br><span class=\"line\">Disabled_sshd_dns #禁用ssh的dns功能</span><br><span class=\"line\">#Shadow_system_version #隐藏系统版本</span><br><span class=\"line\">Modify_network_card_name   #统一网卡名称为eth</span><br><span class=\"line\">#Config_Bond    #配置Bond，默认ip为172.18.30.1，需要手动配置</span><br></pre></td></tr></table></figure>","more":"<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">#</span><br><span class=\"line\">#********************************************************************</span><br><span class=\"line\">#encoding  -*-utf8-*-</span><br><span class=\"line\">#Author:</span><br><span class=\"line\">#Date:         2017-12-19</span><br><span class=\"line\">#URL: </span><br><span class=\"line\">#Description：  The test script</span><br><span class=\"line\">#Copyright (C):    2017 All rights reserved</span><br><span class=\"line\">#QQ Numbers:</span><br><span class=\"line\">#********************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">#查看系统版本 </span><br><span class=\"line\">Get_host_version=`cat /etc/centos-release | grep -i centos | grep -o &quot;\\&lt;[[:digit:]]\\+&quot; |head -1`</span><br><span class=\"line\"></span><br><span class=\"line\">#查看内核版本</span><br><span class=\"line\">kernel_version=`uname -r`</span><br><span class=\"line\"></span><br><span class=\"line\">#设置开机启动文件的权限,设置开机脚本</span><br><span class=\"line\">chmod +x /etc/rc.d/rc.local</span><br><span class=\"line\"></span><br><span class=\"line\">#安装wget必备工具($?上一个执行结果，$$当前进程ID)</span><br><span class=\"line\">function Install_wget()&#123;</span><br><span class=\"line\">    mount /dev/sr0 /mnt</span><br><span class=\"line\">    [ $? -ne 0 ] &amp;&amp; &#123; echo &quot;未添加光盘源！退出脚本&quot; ； kill -9 $$ ; &#125;</span><br><span class=\"line\">    rpm -ivh /mnt/Packages/wget*</span><br><span class=\"line\">    cd /</span><br><span class=\"line\">    umount /mnt    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#修改字符集位zh_CN.UTF-8</span><br><span class=\"line\">function Modify_charaset()&#123;</span><br><span class=\"line\">    echo &apos;export LANG=zh_CN.UTF-8&apos; &gt;&gt;/etc/profile</span><br><span class=\"line\">    export LANG=zh_CN.UTF-8</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#输出错误的系统版本</span><br><span class=\"line\">function Error_system_version()&#123;</span><br><span class=\"line\">    echo &quot;未知的系统版本 $Get_host_version&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#备份操作的相关目录</span><br><span class=\"line\">function Bakup_etc()&#123;</span><br><span class=\"line\">    Now_of_time=`date +&apos;%F_%H.%M&apos;`</span><br><span class=\"line\">    back_path=/bak/initsys/</span><br><span class=\"line\">    mkdir -p $back_path</span><br><span class=\"line\">    tar -czf $back_path/etc.$&#123;Now_of_time&#125;.tar.gz /etc</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#关闭防火墙和selinux(getenforce 获取)</span><br><span class=\"line\">function Off_firewall_and_selinux()&#123;</span><br><span class=\"line\">    #off firewall</span><br><span class=\"line\">    if [ &quot;$Get_host_version&quot; == 7 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        systemctl stop firewalld &amp;&gt;/dev/null</span><br><span class=\"line\">        systemctl disable firewalld &amp;&gt;/dev/null</span><br><span class=\"line\">    elif [ &quot;$Get_host_version&quot; == 6 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        service iptables stop &amp;&gt;/dev/null</span><br><span class=\"line\">        chkconfig iptables off &amp;&gt;/dev/null</span><br><span class=\"line\">    else</span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    #off selinux</span><br><span class=\"line\">    sed -ri &apos;s/^(SELINUX=).*$/\\1disabled/g&apos; /etc/selinux/config</span><br><span class=\"line\">    setenforce 0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#配置时区和时间</span><br><span class=\"line\">function Set_timezone_and_time()&#123;</span><br><span class=\"line\">    /usr/bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class=\"line\">    /usr/sbin/ntpdate 10.180.4.204 #设置ntp服务器同步，如果需要取消注释</span><br><span class=\"line\">    hwclock -w #同步系统时间到硬件时间</span><br><span class=\"line\">    if [ &quot;$Get_host_version&quot; == &apos;6&apos; ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        cat &gt; /etc/sysconfig/clock &lt;&lt; EOF</span><br><span class=\"line\">ZONE=&quot;Asia/Shanghai&quot;</span><br><span class=\"line\">UTC=false</span><br><span class=\"line\">ARC=false</span><br><span class=\"line\">EOF</span><br><span class=\"line\">    elif [ &quot;$Get_host_version&quot; == &apos;7&apos; ] </span><br><span class=\"line\">        then</span><br><span class=\"line\">        timedatectl set-local-rtc yes</span><br><span class=\"line\">    else</span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    fi    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#隐藏系统版本</span><br><span class=\"line\">function Shadow_system_version()&#123;</span><br><span class=\"line\">    echo &apos;&apos; &gt; /etc/issue</span><br><span class=\"line\">    echo &apos;&apos; &gt; /etc/motd</span><br><span class=\"line\">    echo &apos;&apos; &gt; /etc/redhat-release</span><br><span class=\"line\">    echo &apos;&apos; &gt; /etc/centos-release</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#测试外网是否连通</span><br><span class=\"line\">function Test_network()&#123;</span><br><span class=\"line\">    ping -c1 www.baidu.com &amp;&gt;/dev/null</span><br><span class=\"line\">    if [ $? -eq 0 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        return 0</span><br><span class=\"line\">    else</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#设置系统最大句柄数</span><br><span class=\"line\">function Set_handler_Num()&#123;</span><br><span class=\"line\">    limit_count=`cat /etc/security/limits.conf | grep &quot;^\\*[[:blank:]]\\+\\(soft\\|hard\\)[[:blank:]]\\+\\(nofile\\|nproc\\)[[:blank:]]\\+&quot; | wc -l`</span><br><span class=\"line\">    if [ &quot;$limit_count&quot; -eq 0 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class=\"line\">*   soft   nofile   102400 </span><br><span class=\"line\">*   hard   nofile   102400</span><br><span class=\"line\">*   soft   nproc    40960</span><br><span class=\"line\">*   hard   nproc    40960</span><br><span class=\"line\">EOF</span><br><span class=\"line\">        ulimit -n 102400 #设置文件打开数,并马上生效，</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo &quot;已经添加过limit限制!&quot;</span><br><span class=\"line\">    fi</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#优化tcp连接</span><br><span class=\"line\">function Set_tcp_kernel_arguments()&#123;</span><br><span class=\"line\">    kernel_args=/etc/sysctl.d/tcp_optimization.conf</span><br><span class=\"line\">    flag_1=`cat $kernel_args 2&gt;/dev/null | grep tcp_flag | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class=\"line\">    flag_2=`cat $kernel_args 2&gt;/dev/null | grep tcp_flag | wc -l`</span><br><span class=\"line\">    if [ &quot;$flag_2&quot; -gt 1 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        echo &quot;系统错误，TCP重复的优化参数，请查看 $kernel_args 是否正确!&quot;</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    if [ &quot;$flag_1&quot; == 1 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        echo &quot;TCP内核参数已经优化过了。&quot;</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    echo &quot;#tcp_flag 1&quot; &gt;&gt;$kernel_args</span><br><span class=\"line\">    touch $kernel_args</span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_syncookies = 1&quot; &gt;&gt; $kernel_args #开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击</span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_tw_recycle = 1&quot; &gt;&gt; $kernel_args #表示开启TCP连接中TIME-WAIT sockets的快速回收</span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_tw_reuse = 1&quot; &gt;&gt; $kernel_args #表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接</span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_fin_timeout = 5&quot; &gt;&gt; $kernel_args ##指定孤儿连接在内核中生存的时间为5秒 </span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_keepalive_time = 1200&quot; &gt;&gt; $kernel_args #表示当keepalive起用的时候，TCP发送keepalive消息的频度。缺省&gt;是2小时，改为20分钟</span><br><span class=\"line\">    echo &quot;net.ipv4.ip_local_port_range = 10000 65000&quot; &gt;&gt; $kernel_args #表示用于向外连接的端口范围</span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_max_syn_backlog = 8192&quot; &gt;&gt; $kernel_args #表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数</span><br><span class=\"line\">    echo &quot;net.ipv4.tcp_max_tw_buckets = 5000&quot; &gt;&gt; $kernel_args #表示系统同时保持TIME_WAIT的最大数量，如果超过这个数字，TIME_WAIT将立刻被清除并打印警告信息。</span><br><span class=\"line\">    sysctl -p $kernel_args &amp;&gt;/dev/null</span><br><span class=\"line\">    if [ $? != 0 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        echo &apos;读取Tcp内核参数错误！&apos;</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#禁用ssh的DNS功能</span><br><span class=\"line\">#在操作中，我们都会用SSH协议来远程控制虚拟机，但是在输入用户名时候，会有一段时间的卡顿，此时正在进行SSH协议的DNS解析，我们为了快速的连接到虚拟机上，就要关闭这个解析过程</span><br><span class=\"line\">function Disabled_sshd_dns()&#123;</span><br><span class=\"line\">    [ `grep &quot;^#UseDNS \\(no\\|yes\\)&quot; /etc/ssh/sshd_config | wc -l` -eq 0 ] &amp;&amp; &#123; echo &apos;已禁用该配置，Do nothing！&apos; ; return 1; &#125;</span><br><span class=\"line\">    sed -ri &apos;s@#UseDNS (no|yes)@UseDNS no@g&apos; /etc/ssh/sshd_config</span><br><span class=\"line\">    if [ &quot;$Get_host_version&quot; == &apos;6&apos; ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        service sshd restart</span><br><span class=\"line\">    elif [ &quot;$Get_host_version&quot; == &apos;7&apos; ] </span><br><span class=\"line\">        then</span><br><span class=\"line\">        systemctl restart sshd</span><br><span class=\"line\">    else</span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#配置网卡名称为eth*</span><br><span class=\"line\">function Modify_network_card_name()&#123;</span><br><span class=\"line\">    if [ &quot;$Get_host_version&quot; == &apos;6&apos; ] #修改Centos6 的网卡</span><br><span class=\"line\">        then</span><br><span class=\"line\">        Count_cart=`cat /etc/udev/rules.d/70-persistent-net.rules | grep &apos;SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;&apos; | wc -l`</span><br><span class=\"line\">        [ &quot;$Count_cart&quot; -eq 0 ] &amp;&amp; &#123; echo &quot;没有网卡信息，请检查网卡驱动！&quot; ; return 1; &#125;</span><br><span class=\"line\">        count=1</span><br><span class=\"line\">        All_mac=`cat 70-persistent-net.rules | grep &apos;SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;&apos; |grep -o &quot;\\([0-9a-fA-F]\\&#123;2\\&#125;:\\)\\&#123;5\\&#125;[0-9a-fA-F]\\&#123;2\\&#125;&quot;`</span><br><span class=\"line\">        for i in `$ALL_mac`</span><br><span class=\"line\">            do</span><br><span class=\"line\">            sed -ri &apos;s@(&apos;$i&apos;.*NAME=&quot;).*[[:digit:]]+&quot;$@\\1eth&apos;$count&apos;$&quot;@&apos; /etc/udev/rules.d/70-persistent-net.rules</span><br><span class=\"line\">            let count+=1</span><br><span class=\"line\">            done</span><br><span class=\"line\">        echo &apos;修改网卡名成功,请查看配置!&apos;</span><br><span class=\"line\">        echo &quot;`cat /etc/udev/rules.d/70-persistent-net.rules | grep &apos;SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?*&quot;, ATTR&#123;address&#125;==&quot;&apos;`&quot;</span><br><span class=\"line\">    elif [ &quot;$Get_host_version&quot; == &apos;7&apos; ] #修改Centos7 的网卡</span><br><span class=\"line\">        then</span><br><span class=\"line\">        boot_grub=/boot/grub2/grub.cfg</span><br><span class=\"line\">        grub_default_cfg=/etc/default/grub</span><br><span class=\"line\">        Name_count=`cat  $boot_grub 2&gt;/dev/null | grep &quot;quiet[[:blank:]]\\+net.ifnames&quot; | wc -l`</span><br><span class=\"line\">        cp $grub_default_cfg $&#123;grub_default_cfg&#125;.`date +&apos;%F_%H.%M&apos;`</span><br><span class=\"line\">        [ $? -ne 0 ] &amp;&amp; &#123; echo &quot;没有 $grub_default_cfg 这个文件&quot; ; return 1; &#125;</span><br><span class=\"line\">        if [ &quot;$Name_count&quot; -eq 0 ]</span><br><span class=\"line\">            then</span><br><span class=\"line\">            sed -ri &apos;s/(GRUB_CMDLINE_LINUX=.*quiet)/\\1 net.ifnames=0/g&apos; $grub_default_cfg</span><br><span class=\"line\">            grub2-mkconfig -o $boot_grub</span><br><span class=\"line\">            if [ $? -eq 0 ]</span><br><span class=\"line\">                then</span><br><span class=\"line\">                echo &apos;生成新的配置文件，生效需重启！&apos;</span><br><span class=\"line\">            else</span><br><span class=\"line\">                echo &quot;grub文件生成错误！ $boot_grub 可能会产生错误！请检查&quot;</span><br><span class=\"line\">            fi</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo &apos;已经修改过grub参数，无需再次修改！Do nothing！&apos;</span><br><span class=\"line\">        fi</span><br><span class=\"line\">    else</span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#配置yum仓库为aliyun</span><br><span class=\"line\">function Modify_yumrepo()&#123;</span><br><span class=\"line\">    repo_path=/etc/yum.repos.d/</span><br><span class=\"line\">    base_repo_count=`ls $repo_path | grep Alibase.repo | wc -l`</span><br><span class=\"line\">    epel_repo_count=`ls $repo_path | grep epel.repo | wc -l`</span><br><span class=\"line\">    mkdir -p $&#123;repo_path&#125;bak 2&gt;/dev/null</span><br><span class=\"line\">    cd $repo_path</span><br><span class=\"line\">    Test_network</span><br><span class=\"line\">    [ $? -ne 0 ] &amp;&amp; &#123; echo &apos;网络不通,退出函数！&apos; ; return 1; &#125;</span><br><span class=\"line\">    mv CentOS-* bak 2&gt;/dev/null</span><br><span class=\"line\">    #根据系统版本添加源</span><br><span class=\"line\">    if [ &quot;$Get_host_version&quot; -eq 6 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        if [ &quot;$base_repo_count&quot; -eq 0 ];then</span><br><span class=\"line\">            wget https://mirrors.aliyun.com/repo/Centos-6.repo -O $&#123;repo_path&#125;Alibase.repo</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo &quot;已经添加过阿里源！&quot;</span><br><span class=\"line\">        fi</span><br><span class=\"line\">        sleep 1</span><br><span class=\"line\">        if [ &quot;$epel_repo_count&quot; -ne 0 ];then</span><br><span class=\"line\">            wget https://mirrors.aliyun.com/repo/epel-6.repo -O $&#123;repo_path&#125;epel.repo</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo &quot;已经添加过epel源！&quot;</span><br><span class=\"line\">        fi</span><br><span class=\"line\">        yum clean all</span><br><span class=\"line\">    elif [ &quot;$Get_host_version&quot; -eq 7 ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        if [ &quot;$base_repo_count&quot; -eq 0 ];then</span><br><span class=\"line\">            wget https://mirrors.aliyun.com/repo/Centos-7.repo -O $&#123;repo_path&#125;Alibase.repo</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo &quot;已经添加过阿里源！&quot;</span><br><span class=\"line\">        fi</span><br><span class=\"line\">        sleep 1</span><br><span class=\"line\">        if [ &quot;$epel_repo_count&quot; -ne 0 ];then</span><br><span class=\"line\">            wget https://mirrors.aliyun.com/repo/epel-7.repo -O $&#123;repo_path&#125;epel.repo</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo &quot;已经添加过epel源！&quot;</span><br><span class=\"line\">        fi</span><br><span class=\"line\">        yum clean all   </span><br><span class=\"line\">    else</span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#安装一些软件包</span><br><span class=\"line\">function Install_some_packege()&#123;</span><br><span class=\"line\">packges=&quot;gcc glibc zlib openssl openssl-devel lrzsz lftp ftp telnet nmap-ncat net-snmp net-snmp-devel vim sysstat bash-completion wget lsof psmisc ntp&quot;</span><br><span class=\"line\">yum install -y $packges</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#配置Bond</span><br><span class=\"line\">function Config_Bond()&#123;</span><br><span class=\"line\">    [ `ls /etc/sysconfig/network-scripts/ifcfg-Bond* 2&gt;/dev/null | wc -l ` -ne 0 ] &amp;&amp; &#123; echo &apos;已经配置了了Bond&apos; ; return 1; &#125;</span><br><span class=\"line\">    Net_card_name=`netstat -I | sed &apos;1,2d&apos; | sed &apos;/lo/d&apos; | awk &apos;&#123;print $1&#125;&apos;`</span><br><span class=\"line\">    Net_card_Num=`netstat -I | sed &apos;1,2d&apos; | sed &apos;/lo/d&apos; | awk &apos;&#123;print $1&#125;&apos; | wc -l`</span><br><span class=\"line\">    Named_eth_count=`echo $Net_card_name | grep -io eth | wc -l`</span><br><span class=\"line\">    [ &quot;$Named_eth_count&quot; -ne &quot;$Net_card_Num&quot; ] &amp;&amp; &#123; echo &quot;网卡名并未变更为eth，或者已经添加过了聚合类型！配置失败！&quot; ; return 1; &#125;</span><br><span class=\"line\">    net_path=/etc/sysconfig/network-scripts/</span><br><span class=\"line\">    if [ &quot;$Get_host_version&quot; == &apos;6&apos; ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        service NetworkManager stop</span><br><span class=\"line\">        chkconfig NetworkManager off</span><br><span class=\"line\">        for i in $Net_card_name</span><br><span class=\"line\">            do</span><br><span class=\"line\">            cat &gt;&gt;$&#123;net_path&#125;ifcfg-$i &lt;&lt;EOF</span><br><span class=\"line\">DEVICE=$i</span><br><span class=\"line\">BOOTPROTO=none</span><br><span class=\"line\">MASTER=bond0</span><br><span class=\"line\">SLAVE=yes        </span><br><span class=\"line\">USERCTL=no</span><br><span class=\"line\">EOF</span><br><span class=\"line\">            done</span><br><span class=\"line\">        cat &gt;&gt;$&#123;net_path&#125;ifcfg-Bond0 &lt;&lt;EOF</span><br><span class=\"line\">DEVICE=bond0</span><br><span class=\"line\">BOOTPROTO=none</span><br><span class=\"line\">BONDING_OPTS= &quot;miimon=100 mode=0&quot;</span><br><span class=\"line\">DNS1=8.8.8.8</span><br><span class=\"line\">IPADDR=172.18.30.2</span><br><span class=\"line\">PREFIX=16</span><br><span class=\"line\">GATEWAY=172.18.0.1</span><br><span class=\"line\">ONBOOT=yes</span><br><span class=\"line\">EOF</span><br><span class=\"line\">        service network restart</span><br><span class=\"line\">    elif [ &quot;$Get_host_version&quot; == &apos;7&apos; ]</span><br><span class=\"line\">        then</span><br><span class=\"line\">        nmcli con add type bond con-name Bond0 ifname Bond0 mode 0 ipv4.method manual ipv4.addresses 172.18.30.1 ipv4.gateway 172.18.0.1 ipv4.dns 8.8.8.8 &amp;&gt;/dev/null</span><br><span class=\"line\">        [ $? -eq 0 ] &amp;&amp; nmcli con up Bond0</span><br><span class=\"line\">        for i in $Net_card_name</span><br><span class=\"line\">            do</span><br><span class=\"line\">            nmcli con add type bond-slave con-name $i-bond ifname $i master Bond0</span><br><span class=\"line\">            [ $? -eq 0 ] &amp;&amp; nmcli con up $i-bond || echo &quot;激活失败！&quot;</span><br><span class=\"line\">            done</span><br><span class=\"line\">    else</span><br><span class=\"line\">        Error_system_version</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125; </span><br><span class=\"line\">#这里开始调用执行</span><br><span class=\"line\">Bakup_etc   #备份etc</span><br><span class=\"line\">Off_firewall_and_selinux  #关闭selinux</span><br><span class=\"line\">Install_wget #安装wget</span><br><span class=\"line\">#Modify_charaset  #修改全局字符集</span><br><span class=\"line\">Set_timezone_and_time  #设置时区和时间</span><br><span class=\"line\">Set_handler_Num   # 设置打开文件数</span><br><span class=\"line\">Set_tcp_kernel_arguments  #优化内核tcp连接</span><br><span class=\"line\">#Modify_yumrepo   #修改yum仓库</span><br><span class=\"line\">#Install_some_packege #安装一些软件包</span><br><span class=\"line\">Disabled_sshd_dns #禁用ssh的dns功能</span><br><span class=\"line\">#Shadow_system_version #隐藏系统版本</span><br><span class=\"line\">Modify_network_card_name   #统一网卡名称为eth</span><br><span class=\"line\">#Config_Bond    #配置Bond，默认ip为172.18.30.1，需要手动配置</span><br></pre></td></tr></table></figure>","categories":[{"name":"shell脚本","path":"api/categories/shell脚本.json"}],"tags":[{"name":"shell脚本","path":"api/tags/shell脚本.json"}]}